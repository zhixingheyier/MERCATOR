[
    {
        "phase": "initial access",
        "content": "Over the past few months, a number of decoy documents have been used. One of them was a fake TrueType font updater for the Roboto Slab regular font. This choice of font seems a bit odd since it does not support a lot of East-Asian languages. \nWhen executed, this binary decrypts its resource (XOR with a 128-byte, hardcoded key) and decompresses the decrypted data (LZMA). The legitimate RobotoSlab-Regular.ttf (SHA1:912895e6bb9e05af3a1e58a1da417e992a71a324) file is written into the %temp% folder and run via Win32 API function ShellExecute. \nThe shellcode decrypted from the resource is executed. After its execution, the fake font updater drops another application whose sole purpose is to delete the dropper. This \"eraser\" application is dropped as %temp%\\[0-9].tmp.exe. \nThe shellcode is a custom PE loader. It recreates an executable in memory: it decrypts all the sections and computes the necessary relocations and other offsets. The shellcode retrieves three Windows API functions: VirtualAlloc, RtlMoveMemory and RtlZeroMemory. \nThe RtlZeroMemory function is heavily used to zero-out fields in the PE header. Relying on automatic memory dumping will not work since the MZ/PE headers are broken. \nThe shellcode calls the entry-point function of the decrypted PE and then the DLLEntry export function. ",
        "relationship": "1. [CoT]: The text states that the binary decrypts its resource (XOR with a 128-byte, hardcoded key) and decompresses the decrypted data (LZMA), indicating a process-to-file relationship where the binary decrypts a resource file. [Relationships]: <process:binary,decrypts,file:resource (XOR with a 128-byte, hardcoded key)>. \n2. [CoT]: The text mentions that the legitimate RobotoSlab-Regular.ttf file is written into the %temp% folder by the binary, which is later run via the Win32 API function ShellExecute, showing a process-to-file relationship in the context of execution. [Relationships]: <process:binary,writes,file:%temp%\\RobotoSlab-Regular.ttf>. \n3. [CoT]: The text describes that the shellcode is executed after the decryption of the resource, indicating a process-to-file relationship where the binary decrypts and executes the shellcode file. [Relationships]: <process:binary,executes,file:shellcode>. \n4. [CoT]: The text states that the shellcode drops another application named %temp%\\[0-9].tmp.exe, showing a process-to-file relationship where the shellcode drops a file. [Relationships]: <process:shellcode,drops,file:%temp%\\[0-9].tmp.exe>. \n5. [CoT]: The text mentions that the shellcode retrieves three Windows API functions: VirtualAlloc, RtlMoveMemory, and RtlZeroMemory, indicating a process-to-process relationship where the shellcode retrieves functions from the Windows API. [Relationships]: <process:shellcode,retrieves,process:Windows API functions: VirtualAlloc, RtlMoveMemory and RtlZeroMemory>. \n6. [CoT]: The text describes that the shellcode calls the entry-point function of the decrypted PE, showing a process-to-file relationship where the shellcode executes the decrypted PE file. [Relationships]: <process:shellcode,calls,file:decrypted PE>. \n7. [CoT]: The text mentions that the shellcode then calls the DLLEntry export function, indicating a process-to-file relationship where the shellcode executes the DLLEntry function within the decrypted PE. [Relationships]: <process:shellcode,calls,file:DLLEntry export function>. "
    },
    {
        "phase": "persistence",
        "content": "This executable decrypts its resource using the AES algorithm with CBC mode via the Windows API. The size of the hardcoded key is 256 bits. After decryption, the data are decompressed (LZMA algorithm). \nIf the process is running with administrator privileges, then the malware achieves persistence by creating a service, else the classic Windows \"Run\" registry key is used (HKCU\\SOFTWARE\\Microsoft\\ Windows\\CurrentVersion\\Run;DeviceAssociationService;rastlsc.exe). \nIf the dropper is executed with administrator privileges, then it tries to write the following files in the C:\\Program Files\\Symantec\\Symantec Endpoint Protection\\12.1.671.4971.104a\\ DeviceAssociationService\\ folder else it writes them in the %APPDATA%\\Symantec\\Symantec Endpoint Protection\\12.1.671.4971.104a\\DeviceAssociationService\\ folder: \n•\t rastlsc.exe (SHA1:2616da1697f7c764ee7fb558887a6a3279861fac, copy of legitimate Symantec Network Access Control application, dot1xtra.exe)   \n•\t SyLog.bin (SHA1:5689448b4b6260ec9c35f129df8b8f2622c66a45, encrypted backdoor)   \n•\t rastls.dll (SHA1:82e579bd49d69845133c9aa8585f8bd26736437b,malicious DLL sideloaded by rastlsc.exe) \nThe path changes from sample to sample but the pattern is similar. Depending on its privileges, the malware drops the files in %ProgramFiles% or %appdata%. We've also seen: \n•\t \\Symantec\\CNG Key Isolation\\ \n•\t \\Symantec\\Connected User Experiences and Telemetry\\ \n•\t \\Symantec\\DevQuery Background Discovery Broker Tasks\\ \nThese paths are used by various Symantec products. \nAfter achieving persistence and dropping the executable, the legitimate Symantec executable, rastlsc.exe, is executed using CreateProcessW. \nWe've also seen another version ({BB7BDEC9-B59D-492E-A4AF-4C7B1C9E646B}.dll), which executes rastlsc.exe with the parameter krv. Its meaning is discussed below. ",
        "relationship": "1. [CoT]: The text states that the executable decrypts its resource using the AES algorithm, indicating a process-to-file relationship where the process decrypts a resource file. [Relationships]: <process:executable,decrypts,file:resource:AES algorithm>. \n2. [CoT]: The text mentions that after decryption, the data are decompressed using the LZMA algorithm, showing a process-to-file relationship where the process decompresses the decrypted data file. [Relationships]: <process:executable,decompresses,file:resource:LZMA algorithm>. \n3. [CoT]: The malware achieves persistence by creating a service, indicating a process-to-file relationship where the process creates a registry key (HKCU\\SOFTWARE\\Microsoft\\ Windows\\CurrentVersion\\Run;DeviceAssociationService;rastlsc.exe). [Relationships]: <process:malware,creates,reg:HKCU\\SOFTWARE\\Microsoft\\ Windows\\CurrentVersion\\Run;DeviceAssociationService;rastlsc.exe>. \n4. [CoT]: The dropper writes several files to specific folders, indicating process-to-file relationships where the process writes files (rastlsc.exe, SyLog.bin, and rastls.dll). [Relationships]: <process:dropper,writes,file:rastlsc.exe>, <process:dropper,writes,file:SyLog.bin>, <process:dropper,writes,file:rastls.dll>. \n5. [CoT]: The malware drops the files in %ProgramFiles% or %appdata%, indicating a process-to-file relationship where the process drops files in specific folders. [Relationships]: <process:malware,drops,file:files in %ProgramFiles% or %appdata%>. \n6. [CoT]: The legitimate Symantec executable, rastlsc.exe, is executed by the malware, indicating a process-to-process relationship where the malware executes the executable. [Relationships]: <process:malware,executes,process:rastlsc.exe>. \n7. [CoT]: Another version of a DLL executes rastlsc.exe with a parameter, indicating a process-to-process relationship where the DLL executes the executable. [Relationships]: <process:{BB7BDEC9-B59D-492E-A4AF-4C7B1C9E646B}.dll,executes,process:rastlsc.exe>. "
    },
    {
        "phase": "execution",
        "content": "As mentioned earlier, the legitimate executable rastlsc.exe is dropped and executed. \nThis executable imports the rastls.dll file, which in this case contains the malicious payload. \nThe internal name of this dll is {7032F494-0562-4422-9C39-14230E095C52}.dll but we've seen other versions like {5248F13C-85F0-42DF-860D-1723EEAA4F90}.dll. All exported functions lead to the execution of the same function. \nThis export tries to read the SyLog.bin file located inside the same folder. Other versions tried to open the file OUTLFLTR.DAT. If that file exists, it is decrypted using AES in CBC mode with a hardcoded, 256-bit key and then decompressed (LZMA compression). \nThe McUtil.dll variant uses a different technique. At first glance, it looks as if like the main function does nothing malicious, but in fact it replaces the .text section of the legitimate mcoemcpy.exe, a side-loaded binary. It generates shellcode whose purpose is to call the function reading the encrypted stage-two  shellcode in the mcscentr.adf file. \nThe following pseudocode is used to create the shellcode: \nThe result is the following assembly listing: ",
        "relationship": "1. [CoT]: The text states that 'the legitimate executable rastlsc.exe is dropped and executed', indicating that the rastlsc.exe process drops and executes itself.   [Relationships]: <process:rastlsc.exe,drops and executes,self>. \n2. [CoT]: The text mentions that 'This executable imports the rastls.dll file', showing that the rastlsc.exe process imports the rastls.dll file.   [Relationships]: <process:rastlsc.exe,imports,file:rastls.dll>. \n3. [CoT]: The text describes that 'This export tries to read the SyLog.bin file', indicating that the rastls.dll process tries to read the SyLog.bin file.   [Relationships]: <process:rastls.dll,tries to read,file:SyLog.bin>. \n4. [CoT]: The text states that 'Other versions tried to open the file OUTLFLTR.DAT', showing that the rastls.dll process (or other versions) tried to open the OUTLFLTR.DAT file.   [Relationships]: <process:rastls.dll,tried to open,file:OUTLFLTR.DAT>. \n5. [CoT]: The text mentions that 'it replaces the .text section of the legitimate mcoemcpy.exe', indicating that the McUtil.dll process replaces the .text section of the mcoemcpy.exe file.   [Relationships]: <process:McUtil.dll,replaces,file:mcoemcpy.exe>. \n6. [CoT]: The text describes that 'it generates shellcode whose purpose is to call the function', showing that the McUtil.dll process generates shellcode that calls the function.   [Relationships]: <process:McUtil.dll,generates,shellcode>. \n7. [CoT]: The text states that 'whose purpose is to call the function reading the encrypted stage-two', indicating that the shellcode calls the function reading the encrypted stage-two.   [Relationships]: <process:shellcode,calls,file:encrypted stage-two>. \n8. [CoT]: The text mentions that 'the function reading the encrypted stage-two shellcode in the mcscentr.adf file', showing that the mcscentr.adf file contains the encrypted stage-two shellcode.   [Relationships]: <process:mcscentr.adf,contains,file:encrypted stage-two shellcode>. "
    },
    {
        "phase": "execution",
        "content": "The shellcode decrypts and loads the library {E1E4CBED-5690-4749-819D-24FB660DF55F}.dll.   \nThe library retrieves its resource and tries to start the service \"DeviceAssociationService\".   \nThe decrypted data also contains shellcode. The latter decrypts the final layer: the backdoor. \nThe variant {92BA1818-0119-4F79-874E-E3BF79C355B8}.dll checks whether rastlsc.exe was executed with krv as the first parameter. If so, then a job is created and rastlsc.exe is executed again, but without the parameter. ",
        "relationship": "1. [CoT]: The text states \"The shellcode decrypts and loads the library {E1E4CBED-5690-4749-819D-24FB660DF55F}.dll\", indicating that the shellcode process performs the action \"decrypts and loads\" on the library file.   [Relationships]: <process:shellcode,decrypts and loads,file:{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll>. \n2. [CoT]: The text states \"The library retrieves its resource and tries to start the service \"DeviceAssociationService\"\", indicating that the library process performs the action \"tries to start\" on the service process.   [Relationships]: <process:{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll,tries to start,process:DeviceAssociationService>. \n3. [CoT]: The text states \"The decrypted data also contains shellcode. The latter decrypts the final layer: the backdoor\", indicating that the shellcode process performs the action \"decrypts\" on the backdoor file.   [Relationships]: <process:shellcode,decrypts,file:backdoor>. \n4. [CoT]: The text states \"The variant {92BA1818-0119-4F79-874E-E3BF79C355B8}.dll checks whether rastlsc.exe was executed with krv as the first parameter\", indicating that the DLL process performs the action \"checks\" on the exe process.   [Relationships]: <process:{92BA1818-0119-4F79-874E-E3BF79C355B8}.dll,checks,process:rastlsc.exe>. \n5. [CoT]: The text states \"If so, then a job is created and rastlsc.exe is executed again, but without the parameter\", indicating that the DLL process performs the action \"executes\" on the exe process.   [Relationships]: <process:{92BA1818-0119-4F79-874E-E3BF79C355B8}.dll,executes,process:rastlsc.exe>. "
    },
    {
        "phase": "execution",
        "content": "The malware retrieves the first 10 bytes of the username (UTF-16), XORs it with the 3-letter UTF-16 mutex_encoding_str string, and encodes it in hex. The result is used as a mutex name. For instance, for a user whose name starts with abc and the key being vwx, the following mutex will be created: \\Sessions\\1\\BaseNamedObjects\\170015001b. \nThe backdoor includes a PE loader that loads the library HTTPProv.dll in memory, calls its entrypoint and then calls the export function named CreateInstance. ",
        "relationship": "1. [CoT]: The text states that the malware retrieves the first 10 bytes of the username (UTF-16), indicating a process-to-file interaction where the malware process retrieves data from the username file. [Relationships]: <process:malware,retrieves,file:username (UTF-16)>. \n2. [CoT]: The text mentions that the malware XORs the retrieved username bytes with a mutex_encoding_str string, showing a process-to-file interaction where the malware performs operations on the username file data. [Relationships]: <process:malware,XORS,file:username (UTF-16)>. \n3. [CoT]: The text describes encoding the XOR result into hex, indicating a process-to-file interaction where the malware processes the XOR output data. [Relationships]: <process:malware,encodes,file:hex result>. \n4. [CoT]: The text states that a mutex is created with a specific name, showing a process-to-file interaction where the malware process creates a mutex file entity. [Relationships]: <process:malware,creates,file:mutex \\Sessions\\1\\BaseNamedObjects\\170015001b>. \n5. [CoT]: The text mentions that the backdoor loads the library HTTPProv.dll, indicating a process-to-file interaction where the backdoor process loads the DLL file. [Relationships]: <process:backdoor,loads,file:HTTPProv.dll>. \n6. [CoT]: The text states that the backdoor calls the entrypoint of HTTPProv.dll, showing a process-to-file interaction where the backdoor process calls a specific function in the DLL file. [Relationships]: <process:backdoor,calls,file:HTTPProv.dll entrypoint>. \n7. [CoT]: The text mentions that the backdoor calls the export function CreateInstance, indicating a process-to-file interaction where the backdoor process calls a specific function in the DLL file. [Relationships]: <process:backdoor,calls,file:CreateInstance export function>. "
    },
    {
        "phase": "command and control",
        "content": "The backdoor uses a classic TCP communication protocol over port 25123. In order to retrieve the server IP address, the backdoor first creates a particular DNS query. \nThe malware chooses between one of the three domains from the configuration and adds a custom sub-domain generated using two values. The first value is the computer name up to a length of 16 bytes. The second value is the 4-byte version ID. The following Python 2 code implements the encoding algorithm : \nFor instance, if the computer name is random-pc and the version ID is 0x0a841523 then the following domain could be created: \nniggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.dwarduong[.]com \nThe following regular expression could be used to flag a C&C server for this backdoor: \n[ghijklmnopabcdef]{4-60}\\.[ghijklmnopabcdef]{8}\\.[a-z]+\\.[a-z]+ \nIf an IP address is resolved for this particular domain, then the malware tries to establish a connection on TCP port 25123. Each sample has three different domain names it can use to find its C&C server. \nAll communication is encrypted using RC4 and compressed with LZMA. It is possible to decrypt the traffic because the key is prepended to the packets. The format is: \n[RC4 key (4 bytes)][encrypted data] \nEach byte of the key is generated using the rand function. Once the packet is decrypted and decompressed, the data follow the format: \n[dw:unknown][dw:unknown][dw:command number][dw:size of data][dw:unknown] [dw:data] \nThe first time the client connects to the server, a UUID is returned and used as a session ID. The latter is stored in the registry key as binary data: HKCU\\SOFTWARE\\Classes\\ AppXc52346ec40fb4061ad96be0e6cb7d16a\\DefaultIcon \nAs mentioned earlier, the backdoor also contains a library called HTTPprov. This library is an alternative way, as a backup, to communicate with the server as a backup. This DLL sends a POST request over the HTTP protocol to communicate. It also supports HTTPS and the usage of a SOCKS5, SOCKS4a or SOCKS4 proxy. The library is statically linked with libcurl. \nOnce its initialization is done, the following registry key is created to instruct the backdoor to use HTTP in future communication with the C&C server: HKCU\\SOFTWARE\\Classes\\ CLSID{E3517E26-8E93-458D-A6DF-8030BC80528B}. \nA generic user agent is used: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0;   \nTrident/4.0). \nThe most distinctive characteristic of this library is the custom URI encoding algorithm. The resource part of the URI is created using the following pseudocode: \nNOTE: For clarity, the length-checking part has been removed from the snippet. \nFrom this generated string, two numbers are computed based on the custom checksum to obtain a URI: \nBy adding the URI generator of the HTTPprov library, the following URL could be generated: \nhXXp://niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.aisicoin[.]com/ 13/139756-Ses-Ufali-L ",
        "relationship": "1. [CoT]: The text states that the backdoor creates a particular DNS query to retrieve the server IP address, indicating a process-to-socket relationship where the backdoor process creates the DNS query.   [Relationships]: <process:backdoor,creates,socket:DNS query>. \n2. [CoT]: The malware generates a custom sub-domain by encoding the computer name and version ID, indicating a process-to-socket relationship where the malware process creates the domain.   [Relationships]: <process:malware,creates,socket:domain>. \n3. [CoT]: The malware tries to establish a connection to the C&C server on TCP port 25123, indicating a process-to-socket relationship where the malware process connects to the server socket.   [Relationships]: <process:malware,connects,socket:C&C server:25123>. \n4. [CoT]: The backdoor communicates with the C&C server using RC4 encryption, indicating a process-to-socket relationship where the backdoor process communicates with the server socket.   [Relationships]: <process:backdoor,communicates,socket:C&C server>. \n5. [CoT]: The HTTPprov library sends a POST request over the HTTP protocol, indicating a process-to-socket relationship where the library process sends to the HTTP socket.   [Relationships]: <process:HTTPprov,sends,socket:HTTP protocol>. \n6. [CoT]: The HTTPprov library supports the usage of SOCKS proxies, indicating a process-to-socket relationship where the library process uses the SOCKS socket.   [Relationships]: <process:HTTPprov,uses,socket:SOCKS proxy>. \n7. [CoT]: The backdoor creates a registry key to instruct future communication with the C&C server, indicating a process-to-registry relationship where the backdoor process creates the registry key.   [Relationships]: <process:backdoor,creates,reg:HKCU\\SOFTWARE\\Classes\\ AppXc52346ec40fb4061ad96be0e6cb7d16a\\DefaultIcon>. \n8. [CoT]: The HTTPprov library creates a registry key to instruct the backdoor to use HTTP in future communication, indicating a process-to-registry relationship where the library process creates the registry key.   [Relationships]: <process:HTTPprov,creates,reg:HKCU\\SOFTWARE\\Classes\\ CLSID{E3517E26-8E93-458D-A6DF-8030BC80528B}>. \n9. [CoT]: The HTTPprov library sends data using a URL generated by its URI generator, indicating a process-to-socket relationship where the library process sends to the URL socket.   [Relationships]: <process:HTTPprov,sends,socket:URL>. "
    }
]