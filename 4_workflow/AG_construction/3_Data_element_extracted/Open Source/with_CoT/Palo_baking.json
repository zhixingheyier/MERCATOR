[
    {
        "phase": "initial access",
        "content": "Escelar is distributed almost exclusively through phishing emails. A large number of emails were originally seen in the January 2015 period, and more e-mails have continued coming since then at a somewhat slower rate.\nFigure 2. Graph of sessions carrying Escalar each week in 2015\nThese emails are often labeled using the current date, and contain a generic message to entice the victim into running the attachment.\nFigure 3. Example email containing Escelar\nThe following top file names have been observed in attempted infections against Palo Alto Networks customers. Many of them include resume/curriculum vitae themes using female names.",
        "relationship": "[CoT]: The provided text describes the distribution method of Escelar malware through phishing emails but does not mention any specific interactions between processes, files, sockets, or registry entities. It focuses on the malware's delivery mechanism rather than its execution actions or interactions with system entities."
    },
    {
        "phase": "execution",
        "content": "After the victim unzips and executes the attached file, an executable written in .NET will be run. These executables are often obfuscated to thwart reverse engineers and any security controls that may be in place on the victim's machine.\nImportant string names within Escelar samples are obfuscated using various cryptographic libraries. We have identified samples using both RijndaelEnhance and TripleDES.\nFigure 4. Cryptographic function contained in Escelar\nFigure 5. Encrypted string and decrypted version stored as a comment\nThis executable has limited functionality, and is only responsible for downloading an additional executable and establishing persistence via the Run registry key.\nIt begins by generating a random path of 8 alphabetic characters in the %APPDATA% directory. An executable name of 15 random alphabetic characters will hold to a soon-to-be-downloaded file. Escelar then makes a direct connection to a remote Microsoft SQL server and downloads a raw binary file to this local location.\nFigure 6. Microsoft SQL connection\nFigure 7. Acquiring raw binary image from Microsoft SQL server\nFigure 8. Raw binary image\nAfter this file successfully downloads, the following registry key is written to ensure persistence across reboots.\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [Computer Name] : [Path to Executable]\nFinally, the downloaded malware is executed via a call to Interaction.Shell().",
        "relationship": "1. [CoT]: The text states that the victim executes the attached file, which is a file entity.   [Relationships]: <process:victim,executes,file:attached file>. \n2. [CoT]: The text mentions that a .NET executable is run, which is another file entity.   [Relationships]: <process:.NET,runs,file:executable>. \n3. [CoT]: The executable downloads an additional executable, which is a file entity.   [Relationships]: <process:executable,downloads,file:additional executable>. \n4. [CoT]: The executable establishes persistence via the Run registry key, which is a registry key entity.   [Relationships]: <process:executable,establishes,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run>. \n5. [CoT]: The executable generates a random path in the %APPDATA% directory, which is a file entity.   [Relationships]: <process:executable,generates,file:%APPDATA% directory>. \n6. [CoT]: The executable makes a direct connection to a remote Microsoft SQL server, which is a socket entity.   [Relationships]: <process:executable,makes connection to,socket:remote Microsoft SQL server>. \n7. [CoT]: The executable downloads a raw binary file, which is a file entity.   [Relationships]: <process:executable,downloads,file:raw binary file>. \n8. [CoT]: The executable writes the registry key to ensure persistence, which is a registry key entity.   [Relationships]: <process:executable,writes,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run>. \n9. [CoT]: The downloaded malware is executed, which is a process entity.   [Relationships]: <process:Interaction.Shell(),executes,file:malware>. "
    },
    {
        "phase": "command and control",
        "content": "The second stage of the Escelar malware family shares many characteristics with the first stage. Both samples make use of direct Microsoft SQL connections, as well as encryption of important strings within the binary. They're also both written in .NET and are often obfuscated.\nThis sample is once again another downloader, grabbing a raw binary image from a remote Microsoft SQL server and storing it to the following path:\n%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe\nFigure 9. Stored image in Microsoft SQL server\nFinally, the malware is executed via a call to Interaction.Shell().",
        "relationship": "1. [CoT]: The text states that the Escelar malware grabs a binary image from a remote Microsoft SQL server, indicating a process-to-socket interaction where the process (Escelar malware) performs the action 'grabbing' on the socket (remote Microsoft SQL server).   [Relationships]: <process:Escelar malware,grabbing,socket:remote Microsoft SQL server>. \n2. [CoT]: The text describes that the malware stores the grabbed binary image to a specific path, indicating a process-to-file interaction where the process (Escelar malware) performs the action 'storing' on the file (%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe).   [Relationships]: <process:Escelar malware,storing,file:%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe>. "
    },
    {
        "phase": "command and control",
        "content": "The third stage of the malware contains the banking Trojan itself. Once again this binary is written in .NET and makes direct connections to Microsoft SQL servers. It begins by droppingJCS.Components.NeroBar.dllin the Startup folder. This DLL is used to generate progress bars and is used when the attacker chooses to generate a 'blocker' on the victim's banking webpage, which we discuss later in this section.\nThe malware proceeds to identify the following DLLs, which are used by various Brazilian banks to prevent malicious activity. The identifier is stored in the Microsoft SQL database in order to alert the attacker as to what plugins are installed.\nThe IdPC identifier in the following image is made up of the following data.\nComputer Name \nProcessor ID \nHD Serial \nPhysical Memory \nVirtual Memory\nFigure 10. Victim infections of Escelar listed in the Database\nThe malware monitors the victim's browser activity. In the event they user attempts to navigate to one of the following Brazilian banking websites, the malware takes action.\nhttps://internetbanking.caixa.gov.br/SIIBC/index.processa \nhttp://www.bradesco.com.br/ \nhttp://www.bb.com.br/ \nhttps://www.itau.com.br/ \nhttps://www.santander.com.br \nhttps://www.sicredi.com.br \nhttp://www.hsbc.com.br/1/2/br/para-sua-empresa\nShould the victim try to open any of these banking websites in a browser other than Internet Explorer, the malware will generate a false error, close the current browser, and re-open the link in Internet Explorer.\nFigure 11. False error displayed to the victim when viewing a targeted page in Google Chrome\nThe attacker has the ability to send a number of different commands in the 'fun' column of the Microsoft SQL server.\nFigure 12. Commands being sent to victims\nEscalar can accept the commands show below (with their translations).\nThese commands allow the attacker to manipulate a victim's banking web session and perform fraudulent transactions among other functions.\nThe following screenshot shows an image that is used by the malware in order to trick victims into entering the unique authentication code sent by banks to the victim's cellular telephone. This data is uploaded to the attackers in order to conduct fraudulent transactions.\nFigure 13. Escelar tricking a victim into entering the authentication code sent to their cell phone\nThe following screenshot shows examples of an attacker blocking a victim's banking web session in Internet Explorer.\nFigure 14. Blocking of victim's banking web session\nThese pages are specific to the bank the victim is using, as we can see in the following second example.\nFigure 15. Blocking of victim's banking web session",
        "relationship": "1. [CoT]: The text states that the malware drops 'JCS.Components.NeroBar.dll' into the Startup folder, indicating a process-to-file relationship where the malware process drops the file.   [Relationships]: <process:malware,drops,file:JCS.Components.NeroBar.dll>. \n2. [CoT]: The text mentions that the malware monitors the victim's browser activity, specifically targeting certain Brazilian banking websites listed, indicating a process-to-socket relationship where the malware process monitors the victim's browsing actions on these websites.   [Relationships]: <process:malware,monitors,socket:https://internetbanking.caixa.gov.br/SIIBC/index.processa>. \n3. [CoT]: Similar to the previous relationship, the malware monitors browsing activities on more Brazilian banking websites, establishing another process-to-socket relationship.   [Relationships]: <process:malware,monitors,socket:http://www.bradesco.com.br/>. \n4. [CoT]: The malware continues to monitor victim's interactions with various banking websites, maintaining the process-to-socket relationship.   [Relationships]: <process:malware,monitors,socket:http://www.bb.com.br/>. \n5. [CoT]: The malware targets yet another Brazilian banking website in its monitoring efforts, showing consistency in its pattern.   [Relationships]: <process:malware,monitors,socket:https://www.itau.com.br/>. \n6. [CoT]: The malware expands its surveillance to include yet another Brazilian banking domain, indicating a process-to-socket relationship.   [Relationships]: <process:malware,monitors,socket:https://www.santander.com.br/>. \n7. [CoT]: The malware monitors yet another Brazilian banking website as part of its routine activities, maintaining the process-to-socket relationship.   [Relationships]: <process:malware,monitors,socket:https://www.sicredi.com.br/>. \n8. [CoT]: The malware watches for victim's access to a specific HSBC banking URL, showing its wide coverage of targets.   [Relationships]: <process:malware,monitors,socket:http://www.hsbc.com.br/1/2/br/para-sua-empresa>. \n9. [CoT]: The text describes that the malware generates a false error and closes the current browser, indicating a process-to-process relationship where the malware process closes the current browser process (implied as Google Chrome).   [Relationships]: <process:malware,closes,process:Google Chrome>. \n10. [CoT]: The malware re-opens the link in Internet Explorer, showing another process-to-process relationship where the malware process re-opens the link in Internet Explorer.   [Relationships]: <process:malware,re-opens,process:Internet Explorer>. \n11. [CoT]: The text mentions that Escalar can accept commands from the attacker, indicating a process-to-process relationship where the attacker process sends commands to the Escalar process.   [Relationships]: <process:attacker,sends,process:Escalar>. \n12. [CoT]: The malware uploads data, specifically an authentication code, to the attackers, indicating a process-to-file relationship where the malware process uploads the unique authentication code file.   [Relationships]: <process:malware,uploads,file:authentication code>. \n13. [CoT]: The malware blocks the victim's banking web session in Internet Explorer, indicating a process-to-process relationship where the malware process blocks the Internet Explorer process.   [Relationships]: <process:malware,blocks,process:Internet Explorer>. "
    },
    {
        "phase": "credential access",
        "content": "Escelar includes a component that is responsible for harvesting credentials from the following web services.\nGmail \nHotmail \nWebmail (any website containing the string \"webmail\" in the URL)\nThese credentials are stored in a remote Microsoft SQL server. The harvested email credentials are then used by the attackers to send additional e-mails containing Escelar. The total sum of emails in the database displayed below indicated that 3,057 emails had been sent from these addresses. The SQL server keeps track of the number of emails sent by each email address.\nFigure 16. Table containing email addresses and tallies of spam emails sent\nBy harvesting email credentials from Escelar victims, the malware authors are able to further propagate Escelar in the event a portion of the email senders are blocked.",
        "relationship": "1. [CoT]: The text states that Escelar harvests credentials from Gmail, which is a process (Escelar) interacting with a socket (Gmail).   [Relationships]: <process:Escelar,harvests,socket:Gmail>. \n2. [CoT]: The text mentions that Escelar harvests credentials from Hotmail, which is a process (Escelar) interacting with a socket (Hotmail).   [Relationships]: <process:Escelar,harvests,socket:Hotmail>. \n3. [CoT]: The text describes that Escelar harvests credentials from any website containing \"webmail\" in the URL, which is a process (Escelar) interacting with a socket (webmail website).   [Relationships]: <process:Escelar,harvests,socket:webmail website>. \n4. [CoT]: The text states that the harvested credentials (stored as email addresses) are stored in a remote Microsoft SQL server, which is a process (Escelar) interacting with a socket (Microsoft SQL server).   [Relationships]: <process:Escelar,stores,socket:Microsoft SQL server>. \n5. [CoT]: The text indicates that the harvested email credentials are used to send additional emails, which is a process (Escelar) interacting with a socket (emails sent).   [Relationships]: <process:Escelar,uses,socket:emails sent>. "
    }
]