[
    {
        "phase": "initial access",
        "content": "The Ursnif sample from the alert comes from a Microsoft Word document containing a malicious VBA macro. The document is straightforward, simply displaying an image that asks the user to enable macros. If macros are already permitted, the macro is executed automatically when opening the document via the AutoOpen function. \nThe macro is mostly obfuscated code that executes math functions on data that does not relate to the next stage. There is only one line in the macro that is important to executing the next stage, ultimately executing PowerShell. \nInteraction@.Shell RTrim(LTrim(Shapes(\"j6h1cf\").AlternativeText)), 84 \\* 2 + -168 \nThis line accesses the AlternativeText property of the Shapes object \"j6h1cf.\" The value of this property is the malicious PowerShell command, which is subsequently executed by the Shell function. The PowerShell command is base64 encoded, and is another PowerShell command that downloads Ursnif. Specifically, it downloads an executable from its C2 to the AppData directory and executes it. Note, this is where the Exploit Prevention engine stops executing the downloaded file and provides us with alerts to investigate. ",
        "relationship": "1. [CoT]: The text states that the Microsoft Word document contains a malicious VBA macro which is executed when the document is opened or the macros are enabled. The verb 'executes' is used to describe the action of the macro on the document. [Relationships]: <process:Microsoft Word document,executes,process:malicious VBA macro>. \n2. [CoT]: The text mentions that the macro executes PowerShell, indicating a process-to-process relationship where the macro is the executing process and PowerShell is the other process. The verb 'executes' is used to describe this action. [Relationships]: <process:malicious VBA macro,executes,process:PowerShell>. \n3. [CoT]: This section describes how the PowerShell command is obtained from the AlternativeText property of the Shapes object. The PowerShell process accesses the Shapes object 'j6h1cf' , which is a property of the Microsoft Word document process. The verb 'accesses' is used to describe this interaction. [Relationships]: <process:PowerShell,accesses,process:Microsoft Word document Shapes(\"j6h1cf\")>. \n4. [CoT]: The PowerShell command downloads an executable from its C2 (CoT assumes C2 is a socket entity), indicating a process-to-socket relationship. The verb 'downloads' is used to describe this action. [Relationships]: <process:PowerShell,downloads,socket:C2>. \n5. [CoT]: The PowerShell command executes an executable in the AppData directory, indicating a process-to-file relationship. The verb 'executes' is used to describe this action. [Relationships]: <process:PowerShell,executes,file:AppData directory executable>. "
    },
    {
        "phase": "execution",
        "content": "After the Ursnif executable is downloaded and executed, registry data is created that is important for the next stage of execution. \nThe PowerShell command for the next stage of execution resides in the value of the APHohema key, as shown in the image above. \nThis command uses Windows Management Instrumentation Command-line (WMIC) to execute PowerShell, which extracts the value of the Authicap key to execute it. The value of the Authicap key is a hexadecimal-encoded PowerShell command. The WMIC command makes use of /output:clipboard as a way to hide the normal output of process creation that is printed when creating a process with WMIC. \nC:\\WINDOWS\\system32\\wbem\\wmic.exe /output:clipboard process call create \"powershell -w hidden iex([System.Text.Encoding]::ASCII.GetString((get-itemproperty 'HKCU:\\Software\\AppDataLow\\Software\\Microsoft\\236FF8AB-268A-4D1B-4807- ",
        "relationship": "1. [CoT]: The text states that after Ursnif is executed, registry data (APHohema key) is created, indicating a process-to-registry relationship with the verb 'created'.   [Relationships]: <process:Ursnif,created,reg:APHohema key>. \n2. [CoT]: The text mentions that the PowerShell command for the next stage of execution resides in the APHohema key, indicating a process-to-registry relationship with the verb 'retrieve'.   [Relationships]: <process:PowerShell,retrieve,reg:APHohema key>. \n3. [CoT]: The text describes that WMIC is used to execute PowerShell, indicating a process-to-process relationship with the verb 'execute'.   [Relationships]: <process:WMIC,execute,process:PowerShell>. \n4. [CoT]: The text states that WMIC extracts the value of the Authicap key, indicating a process-to-registry relationship with the verb 'extract'.   [Relationships]: <process:WMIC,extract,reg:Authicap key>. \n5. [CoT]: The text mentions that the value of the Authicap key is a hexadecimal-encoded PowerShell command, indicating a process-to-registry relationship with the verb 'decode'.   [Relationships]: <process:WMIC,decode,reg:Authicap key>. \n6. [CoT]: The text describes that WMIC uses /output:clipboard to hide process creation output, indicating a process-to-file relationship with the verb 'hide'. [Relationships]: <process:WMIC,hide,file:/output:clipboard>. "
    },
    {
        "phase": "execution",
        "content": "The hexadecimal-encoded PowerShell command executed from Authicap decodes to a large PowerShell command, of which the most interesting part is base64-encoded. There are three parts to the command. The first part creates a function that is later used to decode base64 encoded PowerShell. The second part creates a byte array containing a malicious DLL. The third part executes the base64 decode function created in the first part, with a base64 encoded string as the parameter to the function. The returned decoded PowerShell is subsequently executed by the shorthand Invoke-Expression (iex) function. \nThe decoded base64 PowerShell that is executed by iex is used to execute an Asynchronous Procedure Call (APC) Injection. \nThe first part of the command creates two variables that import kernel32.dll. In this case, the variables are \\$igaoctlsc and \\$gdopgtvl, as seen being established by the Add-Type cmdlet. \nThe APIs imported from kernel32 are: \nGetCurrentProcess VirtualAllocEx GetCurrentThreadID QueueUserAPC ",
        "relationship": "1. [CoT]: The text states that the PowerShell command is executed from Authicap, indicating that PowerShell is executing the command. [Relationships]: <process:PowerShell,executes,file:hexadecimal-encoded PowerShell command>. \n2. [CoT]: The text mentions that the command creates a function to decode base64 encoded PowerShell, showing that the PowerShell process is creating a function. [Relationships]: <process:PowerShell,creates,function:decode base64 encoded PowerShell>. \n3. [CoT]: The command creates a byte array containing a malicious DLL, indicating that PowerShell is creating or interacting with a malicious DLL file. [Relationships]: <process:PowerShell,creates,file:malicious DLL>. \n4. [CoT]: The text describes executing the base64 decode function with a base64 encoded string, showing that PowerShell executes the function. [Relationships]: <process:PowerShell,executes,function:base64 decode function>. \n5. [CoT]: The decoded base64 PowerShell is executed by the shorthand Invoke-Expression (iex) function, indicating that PowerShell executes the Invoke-Expression function. [Relationships]: <process:PowerShell,executes,function:Invoke-Expression>. \n6. [CoT]: The text states that the decoded base64 PowerShell is used to execute an APC Injection, showing that PowerShell is executing the injection. [Relationships]: <process:PowerShell,executes,process:APC Injection>. \n7. [CoT]: The first part of the command imports kernel32.dll by creating variables, indicating that PowerShell is interacting with kernel32.dll. [Relationships]: <process:PowerShell,imports,file:kernel32.dll>. \n8. [CoT]: The APIs are imported from kernel32.dll, showing that PowerShell is importing these APIs. [Relationships]: <process:PowerShell,imports,process:APIs>. "
    },
    {
        "phase": "defense evasion",
        "content": "SleepEx \nAfter the imports are established, the last portion is a single line that performs the APC Injection via the QueueUserAPC API. Here is the simplified form of that single line, with more readable formatting and normalized variable names. \nThe injection starts by allocating memory for the malicious DLL with VirtualAllocEx, targeting the current process. If the allocation is successful, it then copies the malicious DLL into the newly allocated memory with Copy. Once that is completed, QueueUserAPC is executed, specifying the current thread within its process. This creates a user-mode APC and queues it within the thread. To execute the malicious DLL from the APC queue, the thread needs to enter an alertable state. SleepEx is used to trigger an alertable state completing the APC injection, by specifying 1 (True) for its second parameter which is bAlertable. ",
        "relationship": "1. [CoT]: The text states that QueueUserAPC is executed, specifying the current thread within its process, indicating a process-to-process relationship with the verb 'executes'. [Relationships]: <process:QueueUserAPC,executes,process:current thread>. \n2. [CoT]: The text mentions that SleepEx is used to trigger an alertable state, which requires the current thread to enter an alertable state, indicating a process-to-thread relationship with the verb 'triggers'. [Relationships]: <process:SleepEx,triggers,process:current thread>. "
    },
    {
        "phase": "exfiltration",
        "content": "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT %u.%u%s) \nThe CAB files containing the data to be exfiltrated are stored in %TEMP%, with the filename format being four hexadecimal characters and a .bin extension. As Ursnif logs data to be exfiltrated, it creates CAB files to store the data with the built-in makecab.exe command. The command targets a created MakeCab directive file in the %TEMP% directory. The images below shows the created CAB files in %TEMP% and the MakeCab directives. \nInside the created CAB files are plaintext data in the format: <Current Date and Time> <Process Path> <Window Text> <Keystrokes Logged> ",
        "relationship": "1. [CoT]: The text mentions that Ursnif creates CAB files with a specific filename format in the %TEMP% directory, indicating a process-to-file relationship where Ursnif (process) creates CAB files (file).   [Relationships]: <process:Ursnif,creates,file:%TEMP%\\*.bin>. \n2. [CoT]: The text states that Ursnif logs data to be exfiltrated and then creates CAB files using the makecab.exe command, showing a process-to-file relationship where Ursnif (process) logs data (file).   [Relationships]: <process:Ursnif,logs,file:data to be exfiltrated>. \n3. [CoT]: The text describes that Ursnif uses the built-in makecab.exe command to create CAB files targeting a MakeCab directive file in the %TEMP% directory, indicating a process-to-file relationship where makecab.exe (process) targets the MakeCab directive file (file).   [Relationships]: <process:makecab.exe,targetes,file:MakeCab directive file in the %TEMP% directory>. "
    }
]