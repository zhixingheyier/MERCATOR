[
    {
        "phase": "initial access",
        "content": "During May 2023, we obtained two types of Word documents for analysis. The first type featured an external link embedded within an XML file, \"word/_rels/document.xml.rels,\" while the second type included a VBA script that executed a macro immediately upon opening the document. Notably, both files contained a strikingly similar bait image, depicted in Figure 1.\nThe Word document that targets CVE-2021-40444 contained a file \"document.xml.rels\", shown in Figure 2, with an external link using MHTML (MIME encapsulation of aggregate HTML documents). This web archive file format combines a website's HTML code and companion resources into a single file. This link also uses Cuttly, a URL shortener and link management platform, to redirect users to the cloud file-sharing website, \"GoFile.\" Further analysis revealed that a file named \"defrt.html\" was downloaded upon accessing the link. This file exploits the second vulnerability, CVE-2022-30190. The content of this file and the decoded data is displayed in Figure 3.\nUpon executing the payload, it initiates the download of an injector file named \"oehrjd.exe\" from the following URL: http[:]//pcwizard[.]net/yz/ftp/. Detailed information regarding the execution file can be found in the subsequent section.\nThe second document was discovered towards the end of May. Upon analyzing the VBA script embedded within the Word document, as illustrated in Figure 4, the code is automatically executed due to its use of the \"Auto_Open\" and \"Document_Open\" functions. Various arrays are decoded within the script and saved to a temporary folder under the name \"DD.inf\" (Figure 5). It includes a command to create an \"ema.tmp\" file to store data after line 29 in the \"DD.inf\" file. The data is then encoded using the \"ecodehex\" function and saved as \"des.jpg\". The script then uses rundll32 to load a DLL file with the function \"maintst.\" Finally, it deletes all temporary, JPG, and INF files created throughout this process.",
        "relationship": "1. [Relationships]: <process:Word,embeds,file:word/_rels/document.xml.rels>. \n2. [Relationships]: <process:Word,executes,file:VBA script>. \n3. [Relationships]: <process:VBA script,saves,file:DD.inf>. \n4. [Relationships]: <process:VBA script,creates,file:ema.tmp>. \n5. [Relationships]: <process:VBA script,saves,file:des.jpg>. \n6. [Relationships]: <process:VBA script,loads,file:DLL file>. \n7. [Relationships]: <process:VBA script,deletes,file:temporary files>. \n8. [Relationships]: <process:VBA script,deletes,file:JPG files>. \n9. [Relationships]: <process:VBA script,deletes,file:INF files>. ",
        "semantic_relationship": "[System-level Relationships]: <process:Word,Loadlibrary,file:word/_rels/document.xml.rels>. \n[System-level Relationships]: <process:Word,Execute,file:VBA script>. \n[System-level Relationships]: <process:VBA script,Write,file:DD.inf>. \n[System-level Relationships]: <process:VBA script,Create,file:ema.tmp>. \n[System-level Relationships]: <process:VBA script,Write,file:des.jpg>. \n[System-level Relationships]: <process:VBA script,Loadlibrary,file:DLL file>. \n[System-level Relationships]: <process:VBA script,Delete,file:temporary files>. \n[System-level Relationships]: <process:VBA script,Delete,file:JPG files>. \n[System-level Relationships]: <process:VBA script,Delete,file:INF files>. "
    },
    {
        "phase": "execution",
        "content": "As mentioned, the VBA script creates an INF file to load a DLL. The purpose of this DLL file, named \"des.jpg,\" is to download an injector from the URL \"https[:]//vertebromed[.]md/temp/dhssdf[.]exe\" for use in a later stage. It's worth noting that the download link doesn't belong to a typical file-sharing cloud platform or the attacker's command-and-control (C2) server. Instead, it leverages the website \"vertebromed.md,\" which has been active since 2018. The injector file, \"dhssdf.exe,\" was created on May 29, 2023, as shown in Figure 6. Additionally, within the same folder, we discovered another MSIL loader named \"IMG_3360_103pdf.exe,\" created on May 30, 2023. Although this file isn't directly involved in the Word document attack chain, it also loads LokiBot and connects to the same C2 IP.",
        "relationship": "[Relationships]: None.",
        "semantic_relationship": "None"
    },
    {
        "phase": "execution",
        "content": "In this section, we analyze the injector obtained from Follina (SHA256: 9eaf7231579ab0cb65794043affb10ae8e4ad8f79ec108b5302da2f363b77c93). The injector is written in Visual Basic (VB), and we provide an overview of its basic information in Figure 7.\nInitially, the code extracts individual letters from predetermined strings. These letters are then combined to form an API string, subsequently mapped to the corresponding functions illustrated in Figure 8.\nThe injector utilizes a hardcoded key to decrypt the payload, as shown in Figure 9. The decryption process is outlined in pseudo-code in Figure 10. The decrypted data is decompressed using the \"RtlDecompressBufferEx\" API and the parameter \"COMPRESSION_FORMAT_LZNT1\". The complete procedure through Python code and the partial payload is illustrated in Figure 11.\nThe injector incorporates various evasion techniques, including:\nChecking the \"BeingDebugged\" flag of PEB (Process Environment Block) \nUtilizing the \"NtGlobalFlag\" to determine if the process was created by a debugger \nVerifying the existence of virtual machine paths, such as \"\\VMWare\" and \"\\Oracle\\virtualbox guest additions\" \nEmploying two calls to the \"GetTickCount\" API and using Sleep() to check if the time has been accelerated \nUsing the \"FindWindowW\" function to identify the presence of specific debuggers, such as \"OllyDbg,\" \"x64dbg\", \"x32dbg\", \"WindDbg,\" \"WinDbgFrameClass,\" \"ObsidianGUI,\" \"Soft Ice,\" \"ImmDbg,\" \"Zeta Debugger,\" and \"Rock Debugger\" \nChecking the \"ProcessDebugObjectHandle\" (0x1E)\nAfter obtaining the payload and verifying the overall environment, the injector utilizes the \"VirtualAllocEx\" function to allocate memory for the subsequent execution of LokiBot.",
        "relationship": "1. [Relationships]: <process:injector,extracts,socket:predetermined strings>. \n2. [Relationships]: <process:injector,combines,socket:individual letters>. \n3. [Relationships]: <process:injector,maps,socket:API string>. \n4. [Relationships]: <process:injector,utilizes,file:hardcoded key>. \n5. [Relationships]: <process:injector,decrypts,file:payload>. \n6. [Relationships]: <process:injector,decompresses,file:decrypted data>. \n7. [Relationships]: <process:injector,checks,process:PEB>. \n8. [Relationships]: <process:injector,utilizes,process:NtGlobalFlag>. \n9. [Relationships]: <process:injector,verifies,file:virtual machine paths>. \n10. [Relationships]: <process:injector,uses,socket:GetTickCount API>. \n11. [Relationships]: <process:injector,identifies,process:debuggers>. \n12. [Relationships]: <process:injector,checks,process:ProcessDebugObjectHandle>. \n13. [Relationships]: <process:injector,allocates,process:memory>. \n14. [Relationships]: <process:injector,executes,process:LokiBot>. ",
        "semantic_relationship": "[System-level Relationships]: <process:injector,Receive,socket:predetermined strings>. \n[System-level Relationships]: <process:injector,Receive,socket:individual letters>. \n[System-level Relationships]: <process:injector,Connect,socket:API string>. \n[System-level Relationships]: <process:injector,Read,file:hardcoded key>. \n[System-level Relationships]: <process:injector,Read,file:payload>. \n[System-level Relationships]: <process:injector,Read,file:decrypted data>. \n[System-level Relationships]: <process:injector,Read,process:PEB>. \n[System-level Relationships]: <process:injector,Fork,process:NtGlobalFlag>. \n[System-level Relationships]: <process:injector,Verify,file:virtual machine paths>. \n[System-level Relationships]: <process:injector,Connect,socket:GetTickCount API>. \n[System-level Relationships]: <process:injector,Exit,process:debuggers>. \n[System-level Relationships]: <process:injector,Read,process:ProcessDebugObjectHandle>. \n[System-level Relationships]: <process:injector,Inject,process:memory>. \n[System-level Relationships]: <process:injector,Fork,process:LokiBot>. "
    },
    {
        "phase": "collection",
        "content": "LokiBot is specifically designed to gather sensitive information from various sources, including web browsers, FTP, email, and numerous software tools installed on the compromised system. Analyzing the C2 traffic to \"95[.]164[.]23[.]2/swe/h/pin[.]php\" in Figure 13, we determined that the version is 0x0012 and the notable Binary ID is \"ckav[.]ru\". As this version of LokiBot has remained unchanged since March, we will only highlight its major components and features.\nFirst, the MD5 hash derived from the MachineGuid is in the end pcap, \"D0BECCE5760947DD9FFD80DB\". This hash serves as a mutex to ensure that multiple instances of LokiBot are not running simultaneously. It employs the \"MoveFileExW\" API to create a folder named \"%APPDATA%\\Roaming\\576094\" and a file named \"47DD9F.exe\" using a substring of the MD5 from MachineGuid. The file is marked as hidden by the \"SetFileAttributes\" function and setting the attribute to FILE_ATTRIBUTE_HIDDEN (0x2). The corresponding registry settings associated with LokiBot are depicted in Figure 14.\nThe list of targeted software names is stored in an array, and a partial list is provided in Figure 15.",
        "relationship": "[Relationships]: n/a",
        "semantic_relationship": "None"
    },
    {
        "phase_relationship": [
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:Word,embeds,file:word/_rels/document.xml.rels>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Word,Loadlibrary,file:word/_rels/document.xml.rels>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:Word,executes,file:VBA script>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Word,Execute,file:VBA script>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,saves,file:DD.inf>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Write,file:DD.inf>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,creates,file:ema.tmp>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Create,file:ema.tmp>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,saves,file:des.jpg>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Write,file:des.jpg>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,loads,file:DLL file>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Loadlibrary,file:DLL file>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,deletes,file:temporary files>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Delete,file:temporary files>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,deletes,file:JPG files>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Delete,file:JPG files>. "
            },
            {
                "phase": "initial access",
                "relationship": "[Original Relationships]: <process:VBA script,deletes,file:INF files>. ",
                "semantic_relationship": "[System-level Relationships]: <process:VBA script,Delete,file:INF files>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,extracts,socket:predetermined strings>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Receive,socket:predetermined strings>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,combines,socket:individual letters>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Receive,socket:individual letters>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,maps,socket:API string>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Connect,socket:API string>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,utilizes,file:hardcoded key>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Read,file:hardcoded key>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,decrypts,file:payload>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Read,file:payload>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,decompresses,file:decrypted data>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Read,file:decrypted data>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,checks,process:PEB>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Read,process:PEB>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,utilizes,process:NtGlobalFlag>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Fork,process:NtGlobalFlag>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,verifies,file:virtual machine paths>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Verify,file:virtual machine paths>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,uses,socket:GetTickCount API>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Connect,socket:GetTickCount API>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,identifies,process:debuggers>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Exit,process:debuggers>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,checks,process:ProcessDebugObjectHandle>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Read,process:ProcessDebugObjectHandle>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,allocates,process:memory>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Inject,process:memory>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:injector,executes,process:LokiBot>. ",
                "semantic_relationship": "[System-level Relationships]: <process:injector,Fork,process:LokiBot>. "
            }
        ]
    }
]