[
    {
        "phase": "initial access",
        "content": "Escelar is distributed almost exclusively through phishing emails. A large number of emails were originally seen in the January 2015 period, and more e-mails have continued coming since then at a somewhat slower rate.\nFigure 2. Graph of sessions carrying Escalar each week in 2015\nThese emails are often labeled using the current date, and contain a generic message to entice the victim into running the attachment.\nFigure 3. Example email containing Escelar\nThe following top file names have been observed in attempted infections against Palo Alto Networks customers. Many of them include resume/curriculum vitae themes using female names.",
        "relationship": "[Relationships]: None.",
        "semantic_relationship": "None"
    },
    {
        "phase": "execution",
        "content": "After the victim unzips and executes the attached file, an executable written in .NET will be run. These executables are often obfuscated to thwart reverse engineers and any security controls that may be in place on the victim's machine.\nImportant string names within Escelar samples are obfuscated using various cryptographic libraries. We have identified samples using both RijndaelEnhance and TripleDES.\nFigure 4. Cryptographic function contained in Escelar\nFigure 5. Encrypted string and decrypted version stored as a comment\nThis executable has limited functionality, and is only responsible for downloading an additional executable and establishing persistence via the Run registry key.\nIt begins by generating a random path of 8 alphabetic characters in the %APPDATA% directory. An executable name of 15 random alphabetic characters will hold to a soon-to-be-downloaded file. Escelar then makes a direct connection to a remote Microsoft SQL server and downloads a raw binary file to this local location.\nFigure 6. Microsoft SQL connection\nFigure 7. Acquiring raw binary image from Microsoft SQL server\nFigure 8. Raw binary image\nAfter this file successfully downloads, the following registry key is written to ensure persistence across reboots.\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [Computer Name] : [Path to Executable]\nFinally, the downloaded malware is executed via a call to Interaction.Shell().",
        "relationship": "1. [Relationships]: <process:attached file,executes,process:.NET executable>. \n2. [Relationships]: <process:.NET executable,downloads,file:additional executable>. \n3. [Relationships]: <process:.NET executable,establishes,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run>. \n4. [Relationships]: <process:Escelar,generates,file:%APPDATA% directory>. \n5. [Relationships]: <process:Escelar,connects,socket:remote Microsoft SQL server>. \n6. [Relationships]: <process:Escelar,downloads,file:raw binary file>. \n7. [Relationships]: <process:.NET executable,writes,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [Computer Name] : [Path to Executable]>. ",
        "semantic_relationship": "[System-level Relationships]: <process:attached file,Execute,process:.NET executable>. \n[System-level Relationships]: <process:.NET executable,Write,file:additional executable>. \n[System-level Relationships]: <process:.NET executable,Writekey,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run>. \n[System-level Relationships]: <process:Escelar,Create,file:%APPDATA% directory>. \n[System-level Relationships]: <process:Escelar,Connect,socket:remote Microsoft SQL server>. \n[System-level Relationships]: <process:Escelar,Write,file:raw binary file>. \n[System-level Relationships]: <process:.NET executable,Writekey,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [Computer Name] : [Path to Executable]>. "
    },
    {
        "phase": "command and control",
        "content": "The second stage of the Escelar malware family shares many characteristics with the first stage. Both samples make use of direct Microsoft SQL connections, as well as encryption of important strings within the binary. They're also both written in .NET and are often obfuscated.\nThis sample is once again another downloader, grabbing a raw binary image from a remote Microsoft SQL server and storing it to the following path:\n%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe\nFigure 9. Stored image in Microsoft SQL server\nFinally, the malware is executed via a call to Interaction.Shell().",
        "relationship": "1. [Relationships]: <process:Escelar malware,grabbing,socket:remote Microsoft SQL server>. \n2. [Relationships]: <process:Escelar malware,storing,file:%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe>. ",
        "semantic_relationship": "[System-level Relationships]: <process:Escelar malware,Receive,socket:remote Microsoft SQL server>. \n[System-level Relationships]: <process:Escelar malware,Write,file:%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe>. "
    },
    {
        "phase": "command and control",
        "content": "The third stage of the malware contains the banking Trojan itself. Once again this binary is written in .NET and makes direct connections to Microsoft SQL servers. It begins by droppingJCS.Components.NeroBar.dllin the Startup folder. This DLL is used to generate progress bars and is used when the attacker chooses to generate a 'blocker' on the victim's banking webpage, which we discuss later in this section.\nThe malware proceeds to identify the following DLLs, which are used by various Brazilian banks to prevent malicious activity. The identifier is stored in the Microsoft SQL database in order to alert the attacker as to what plugins are installed.\nThe IdPC identifier in the following image is made up of the following data.\nComputer Name \nProcessor ID \nHD Serial \nPhysical Memory \nVirtual Memory\nFigure 10. Victim infections of Escelar listed in the Database\nThe malware monitors the victim's browser activity. In the event they user attempts to navigate to one of the following Brazilian banking websites, the malware takes action.\nhttps://internetbanking.caixa.gov.br/SIIBC/index.processa \nhttp://www.bradesco.com.br/ \nhttp://www.bb.com.br/ \nhttps://www.itau.com.br/ \nhttps://www.santander.com.br \nhttps://www.sicredi.com.br \nhttp://www.hsbc.com.br/1/2/br/para-sua-empresa\nShould the victim try to open any of these banking websites in a browser other than Internet Explorer, the malware will generate a false error, close the current browser, and re-open the link in Internet Explorer.\nFigure 11. False error displayed to the victim when viewing a targeted page in Google Chrome\nThe attacker has the ability to send a number of different commands in the 'fun' column of the Microsoft SQL server.\nFigure 12. Commands being sent to victims\nEscalar can accept the commands show below (with their translations).\nThese commands allow the attacker to manipulate a victim's banking web session and perform fraudulent transactions among other functions.\nThe following screenshot shows an image that is used by the malware in order to trick victims into entering the unique authentication code sent by banks to the victim's cellular telephone. This data is uploaded to the attackers in order to conduct fraudulent transactions.\nFigure 13. Escelar tricking a victim into entering the authentication code sent to their cell phone\nThe following screenshot shows examples of an attacker blocking a victim's banking web session in Internet Explorer.\nFigure 14. Blocking of victim's banking web session\nThese pages are specific to the bank the victim is using, as we can see in the following second example.\nFigure 15. Blocking of victim's banking web session",
        "relationship": "1. [Relationships]: <process:malware, drops, file:JCS.Components.NeroBar.dll>. \n2. [Relationships]: <process:malware, identifies, file:IdPC identifier>. \n3. [Relationships]: <process:malware, monitors, socket:https://internetbanking.caixa.gov.br/SIIBC/index.processa>. \n4. [Relationships]: <process:malware, monitors, socket:http://www.bradesco.com.br/>. \n5. [Relationships]: <process:malware, monitors, socket:http://www.bb.com.br/>. \n6. [Relationships]: <process:malware, monitors, socket:https://www.itau.com.br/>. \n7. [Relationships]: <process:malware, monitors, socket:https://www.santander.com.br>. \n8. [Relationships]: <process:malware, monitors, socket:https://www.sicredi.com.br>. \n9. [Relationships]: <process:malware, monitors, socket:http://www.hsbc.com.br/1/2/br/para-sua-empresa>. \n10. [Relationships]: <process:malware, generates, file:False error>. \n11. [Relationships]: <process:malware, uploads, socket:attacker>. \n12. [Relationships]: <process:malware, blocks, socket:victim's banking web session>. ",
        "semantic_relationship": "[System-level Relationships]: <process:malware,Create,file:JCS.Components.NeroBar.dll>. \n[System-level Relationships]: <process:malware,Read,file:IdPC identifier>. \n[System-level Relationships]: <process:malware,Connect,socket:https://internetbanking.caixa.gov.br/SIIBC/index.processa>. \n[System-level Relationships]: <process:malware, Connect, socket:http://www.bradesco.com.br/>. \n[System-level Relationships]: <process:malware, Connect, socket:http://www.bb.com.br/>. \n[System-level Relationships]: <process:malware,Connect,socket:https://www.itau.com.br/>. \n[System-level Relationships]: <process:malware,Connect,socket:https://www.santander.com.br>. \n[System-level Relationships]: <process:malware, Connect, socket:https://www.sicredi.com.br>. \n[System-level Relationships]: <process:malware, Connect, socket:http://www.hsbc.com.br/1/2/br/para-sua-empresa>. \n[System-level Relationships]: <process:malware,Create,file:False error>. \n[System-level Relationships]: <process:malware,Send,socket:attacker>. \n[System-level Relationships]: <process:malware, Connect, socket:victim's banking web session>. "
    },
    {
        "phase": "credential access",
        "content": "Escelar includes a component that is responsible for harvesting credentials from the following web services.\nGmail \nHotmail \nWebmail (any website containing the string \"webmail\" in the URL)\nThese credentials are stored in a remote Microsoft SQL server. The harvested email credentials are then used by the attackers to send additional e-mails containing Escelar. The total sum of emails in the database displayed below indicated that 3,057 emails had been sent from these addresses. The SQL server keeps track of the number of emails sent by each email address.\nFigure 16. Table containing email addresses and tallies of spam emails sent\nBy harvesting email credentials from Escelar victims, the malware authors are able to further propagate Escelar in the event a portion of the email senders are blocked.",
        "relationship": "1. [Relationships]: <process:Escelar,harvests,socket:Gmail>. \n2. [Relationships]: <process:Escelar,harvests,socket:Hotmail>. \n3. [Relationships]: <process:Escelar,harvests,socket:Webmail>. \n4. [Relationships]: <process:Escelar,stores,socket:remote Microsoft SQL server>. \n5. [Relationships]: <process:Escelar,uses,socket:Microsoft SQL server>. ",
        "semantic_relationship": "[System-level Relationships]: <process:Escelar,Receive,socket:Gmail>. \n[System-level Relationships]: <process:Escelar,Receive,socket:Hotmail>. \n[System-level Relationships]: <process:Escelar,Receive,socket:Webmail>. \n[System-level Relationships]: <process:Escelar,Send,socket:remote Microsoft SQL server>. \n[System-level Relationships]: <process:Escelar,Connect,socket:Microsoft SQL server>. "
    },
    {
        "phase_relationship": [
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:attached file,executes,process:.NET executable>. ",
                "semantic_relationship": "[System-level Relationships]: <process:attached file,Execute,process:.NET executable>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:.NET executable,downloads,file:additional executable>. ",
                "semantic_relationship": "[System-level Relationships]: <process:.NET executable,Write,file:additional executable>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:.NET executable,establishes,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run>. ",
                "semantic_relationship": "[System-level Relationships]: <process:.NET executable,Writekey,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:Escelar,generates,file:%APPDATA% directory>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Create,file:%APPDATA% directory>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:Escelar,connects,socket:remote Microsoft SQL server>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Connect,socket:remote Microsoft SQL server>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:Escelar,downloads,file:raw binary file>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Write,file:raw binary file>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:.NET executable,writes,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [Computer Name] : [Path to Executable]>. ",
                "semantic_relationship": "[System-level Relationships]: <process:.NET executable,Writekey,reg:HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run [Computer Name] : [Path to Executable]>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:Escelar malware,grabbing,socket:remote Microsoft SQL server>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar malware,Receive,socket:remote Microsoft SQL server>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:Escelar malware,storing,file:%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar malware,Write,file:%TEMP%\\\\JO[Computer Name][Computer Virtual Memory].exe>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, drops, file:JCS.Components.NeroBar.dll>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Create,file:JCS.Components.NeroBar.dll>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, identifies, file:IdPC identifier>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Read,file:IdPC identifier>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:https://internetbanking.caixa.gov.br/SIIBC/index.processa>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Connect,socket:https://internetbanking.caixa.gov.br/SIIBC/index.processa>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:http://www.bradesco.com.br/>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware, Connect, socket:http://www.bradesco.com.br/>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:http://www.bb.com.br/>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware, Connect, socket:http://www.bb.com.br/>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:https://www.itau.com.br/>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Connect,socket:https://www.itau.com.br/>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:https://www.santander.com.br>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Connect,socket:https://www.santander.com.br>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:https://www.sicredi.com.br>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware, Connect, socket:https://www.sicredi.com.br>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, monitors, socket:http://www.hsbc.com.br/1/2/br/para-sua-empresa>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware, Connect, socket:http://www.hsbc.com.br/1/2/br/para-sua-empresa>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, generates, file:False error>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Create,file:False error>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, uploads, socket:attacker>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Send,socket:attacker>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:malware, blocks, socket:victim's banking web session>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware, Connect, socket:victim's banking web session>. "
            },
            {
                "phase": "credential access",
                "relationship": "[Original Relationships]: <process:Escelar,harvests,socket:Gmail>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Receive,socket:Gmail>. "
            },
            {
                "phase": "credential access",
                "relationship": "[Original Relationships]: <process:Escelar,harvests,socket:Hotmail>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Receive,socket:Hotmail>. "
            },
            {
                "phase": "credential access",
                "relationship": "[Original Relationships]: <process:Escelar,harvests,socket:Webmail>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Receive,socket:Webmail>. "
            },
            {
                "phase": "credential access",
                "relationship": "[Original Relationships]: <process:Escelar,stores,socket:remote Microsoft SQL server>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Send,socket:remote Microsoft SQL server>. "
            },
            {
                "phase": "credential access",
                "relationship": "[Original Relationships]: <process:Escelar,uses,socket:Microsoft SQL server>. ",
                "semantic_relationship": "[System-level Relationships]: <process:Escelar,Connect,socket:Microsoft SQL server>. "
            }
        ]
    }
]