[
    {
        "phase": "initial access",
        "content": "The attack begins when a user downloads and runs an HTML application (HTA) file named Player1566444384.hta. The digits in the file name differ in every attack. Analysis of Microsoft Defender ATP telemetry points to compromised advertisements as the most likely infection vector for delivering the HTA files. The mshta.exe tool (which runs when an HTA file runs) was launched with the - embedding command-line parameter, which typically indicates that the launch action was initiated by the browser. \nFurthermore, immediately prior to the execution of the HTA file, the telemetry always shows network activity towards suspicious advertisement services (which may vary slightly across infections), and a consistent access to legitimate content \nBring your own LOLBin: Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware | Microsoft Security Blog delivery service Cloudfront. Cloudfront is not a malicious entity or service, and it was likely used by the attackers exactly for that reason: because it's not a malicious domain, it won't likely raise alarms. Examples of such domains observed in several campaigns are: \nd23cy16qyloios[.]cloudfront[.]net d26klsbste71cl[.]cloudfront [.]net d2d604b63pweib[.]cloudfront [.]net d3jo79y1m6np83[.]cloudfront [.]net d1fctvh5cp9yen[.]cloudfront [.]net d3cp2f6v8pu0j2[.]cloudfront[.]net dqsiu450ekr8q[.]cloudfront [.]net \nIt's possible that these domains were abused to deliver the HTA files without alerting the browser. Another content delivery service abused later on in the attack chain is Cdn77. Some examples of observed URLs include: \nhxxps://1292172017[.]rsc [.]cdn77 [.]org/images/trpl[.]png hxxps://1292172017[.]rsc.cdn77[.]org/imtrack/strkp[.]png \nThis same strategy was also used by the Astaroth campaign, where the malware authors hosted their malware on the legitimate storage.googleapis.com service. ",
        "relationship": "[Relationships]: None.",
        "semantic_relationship": "None"
    },
    {
        "phase": "command and control",
        "content": "When the HTA file runs, it tries to reach out to a randomly named domain to download additional JavaScript code. The domains used in this first stage are shortlived: they are registered and brought online and, after a day or two (the span of a typical campaign), they are dropped and their related DNS entries are removed. This can make it more difficult to investigate and retrieve the components that were delivered to victims. Examples of domains observed include: \nDu0ohrealgeek[.]org \u2013 active from August 12 to 14 Hi5urautopapyrus[.]org \u2013 active from April 21 to 22 Ex9ohiamistanbul[.]net \u2013 active from August 1 to 2 Eek6omyfilmbiznetwork[.]org \u2013 active from July 23 to 24 \nThis stage is just a downloader: it tries to retrieve either a JavaScript or an extensible style language (XSL) file from the command-and-control (C&C) domain. These files have semi-random names like 1566444384.js and 1566444384.xsl, where the digits are different in every download. After this file is downloaded and runs, it contacts the remote C&C domain to download an RC4-encrypted file named 1566444384.mp4 and a decryption key from a file named 1566444384.flv. When decrypted, the MP4 file is an additional JavaScript snippet that starts PowerShell: \na.Environment('Process')(\"deadbeef\") $=$ \"iex([Text.Encoding]::ASCII.GetStr a.Run(\"\\\"\"+p+\"\\\" -Enc LgAoACIAewAwAHOAewAxAHOAIgAgACOAZgAnAGkAJwAsACcAZQE \nInterestingly, it hides the malicious PowerShell script in an environment variable named \"deadbeef\" (first line), then it launches PowerShell with an encoded command (second line) that simply runs the contents of the \"deadbeef\" variable. This trick, which is used several times during the infection chain, is usually employed to hide the real malicious script so that it does not appear in the command-line of a PowerShell process. ",
        "relationship": "1. [Relationships]: <process:HTA file,reaches out to,socket:randomly named domain>. \n2. [Relationships]: <process:HTA file,downloads,file:JavaScript code>. \n3. [Relationships]: <process:HTA file,contacts,socket:C&C domain>. \n4. [Relationships]: <process:file:1566444384.js,contacts,socket:C&C domain>. \n5. [Relationships]: <process:file:1566444384.xsl,contacts,socket:C&C domain>. \n6. [Relationships]: <process:file:1566444384.mp4,contacts,socket:C&C domain>. \n7. [Relationships]: <process:file:1566444384.flv,contacts,socket:C&C domain>. \n8. [Relationships]: <process:PowerShell,launches,process:JavaScript snippet>. \n9. [Relationships]: <process:HTA file,hides,file:malicious PowerShell script>. \n10. [Relationships]: <process:PowerShell,runs,file:deadbeef variable>. ",
        "semantic_relationship": "[System-level Relationships]: <process:HTA file,Connect,socket:randomly named domain>. \n[System-level Relationships]: <process:HTA file,Write,file:JavaScript code>. \n[System-level Relationships]: <process:HTA file,Connect,socket:C&C domain>. \n[System-level Relationships]: <process:file:1566444384.js,Connect,socket:C&C domain>. \n[System-level Relationships]: <process:file:1566444384.xsl,Connect,socket:C&C domain>. \n[System-level Relationships]: <process:file:1566444384.mp4,Connect,socket:C&C domain>. \n[System-level Relationships]: <process:file:1566444384.flv,Connect,socket:C&C domain>. \n[System-level Relationships]: <process:PowerShell,Fork,process:JavaScript snippet>. \n[System-level Relationships]: <process:HTA file,Write,file:malicious PowerShell script>. \n[System-level Relationships]: <process:PowerShell,Execute,file:deadbeef variable>. "
    },
    {
        "phase": "execution",
        "content": "Nodersok's infection continues by launching several instances of PowerShell to download and run additional malicious modules. All the modules are hosted on the C&C servers in RC4-encrypted form and are decrypted on the fly before they run on the device. The following steps are perpetrated by the various instances of PowerShell: \nDownload module.avi, a module that attempts to: Disable Windows Defender Antivirus Disable Windows updates \nBring your own LOLBin: Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware | Microsoft Security Blog Run binary shellcode that attempts elevation of privilege by using autoelevated COM interface   \nDownload additional modules trpl.png and strkp.png hosted on a Cdn77 service   \nDownload legitimate node.exe tool from the official nodejs.org website   \nDrop the WinDivert packet capture library components WinDivert.dll, WinDivert32.sys, and WinDivert64.sys   \nExecute a shellcode that uses WinDivert to filter and modify certain outgoing packets   \nFinally, drop the JavaScript payload along with some Node.js modules and libraries required by it, and run it via node.exe \nThis last JavaScript is the actual final payload written for the Node.js framework that turns the device into a proxy. This concludes the infection, at the end of which the network packet filter is active and the machine is working as a potential proxy zombie. When a machine turns into a proxy, it can be used by attackers as a relay to access other network entities (websites, C&C servers, compromised machines, etc.), which can allow them to perform stealthy malicious activities. ",
        "relationship": "1. [Relationships]: <process:PowerShell,download,file:module.avi>. \n2. [Relationships]: <process:PowerShell,disable,process:Windows Defender Antivirus>. \n3. [Relationships]: <process:PowerShell,disable,process:Windows updates>. \n4. [Relationships]: <process:PowerShell,run,file:binary shellcode>. \n5. [Relationships]: <process:PowerShell,download,file:trpl.png>. \n6. [Relationships]: <process:PowerShell,download,file:strkp.png>. \n7. [Relationships]: <process:PowerShell,download,file:node.exe>. \n8. [Relationships]: <process:PowerShell,drop,file:WinDivert.dll>. \n9. [Relationships]: <process:PowerShell,drop,file:WinDivert32.sys>. \n10. [Relationships]: <process:PowerShell,drop,file:WinDivert64.sys>. \n11. [Relationships]: <process:PowerShell,execute,file:shellcode>. \n12. [Relationships]: <process:node.exe,run,file:JavaScript payload>. ",
        "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Write,file:module.avi>. \n[System-level Relationships]: <process:PowerShell,Exit,process:Windows Defender Antivirus>. \n[System-level Relationships]: <process:PowerShell,Exit,process:Windows updates>. \n[System-level Relationships]: <process:PowerShell,Execute,file:binary shellcode>. \n[System-level Relationships]: <process:PowerShell,Write,file:trpl.png>. \n[System-level Relationships]: <process:PowerShell,Write,file:strkp.png>. \n[System-level Relationships]: <process:PowerShell,Write,file:node.exe>. \n[System-level Relationships]: <process:PowerShell,Delete,file:WinDivert.dll>. \n[System-level Relationships]: <process:PowerShell,Write,file:WinDivert32.sys>. \n[System-level Relationships]: <process:PowerShell,Delete,file:WinDivert64.sys>. \n[System-level Relationships]: <process:PowerShell,Execute,file:shellcode>. \n[System-level Relationships]: <process:node.exe,Execute,file:JavaScript payload>. "
    },
    {
        "phase": "execution",
        "content": "This is not the first threat to abuse Node.js. Some cases have been observed in the past (for example this ransomware from early 2016). However, using Node.js is a peculiar way to spread malware. Besides being clean and benign, Node.exe also has a valid digital signature, allowing a malicious JavaScript to operate within the context of a trusted process. The JavaScript payload itself is relatively simple: it only contains a set of basic functions that allows it to act as a proxy for a remote entity. \nthis.send $\\equiv$ function(ddd) this.close $=$ function() 1 function backconnect (lurl) const socket $=$ $()=>1$ $=$ 1); 1); else 1); \nBring your own LOLBin: Multi-stage, fileless Nodersok campaign delivers rare Node.js-based malware | Microsoft Secu The code seems to be still in its infancy and in development, but it does work. It has two purposes: \n1. Connect back to the remote C&C, and   \n2. Receive HTTP requests to proxy back to it \nIt supports the SOCKS4A protocol. While we haven't observed network requests coming from attackers, we wrote what the Node.js-based C&C server application may look like: a server that sends HTTP requests to the infected clients that connect back to it, and receives the responses from said clients. we slightly modified the malicious JavaScript malware to make it log meaningful messages, ran a JavaScript server, ran the JavaScript malware, and it proxied HTTP requests as expected: \nThe server starts, then the client starts and connects to it. In response, the server sends a HTTP request (using the Socks4A protocol) to the client. The request is a simple HTTP GET. The client proxies the HTTP request to the target website and returns the HTTP response (200 OK) and the HTML page back to the server. This test demonstrates that it's possible to use this malware as a proxy. ",
        "relationship": "[Relationships]: None.",
        "semantic_relationship": "None"
    },
    {
        "phase": "execution",
        "content": "As mentioned earlier, there exist other variants of this malware. For example, we found one named 05sall.js (possibly an earlier version). It's similar in structure to the one described above, but the payload was not developed in Node.js (rather it was an executable). Furthermore, beyond acting as a proxy, it can run additional commands such as update, terminate, or run shell commands. \nThe malware can also process configuration data in JSON format. For example, this configuration was encoded and stored in the registry in an infected machine: \nThe configuration is an indication of the modular nature of the malware. It shows the names of two modules being used in this infection (named block_av_01 and all_socks_05). ",
        "relationship": "1. [Relationships]: <process:05sall.js,run,process:executable>. \n2. [Relationships]: <process:05sall.js,run,process:update>. \n3. [Relationships]: <process:05sall.js,run,process:terminate>. \n4. [Relationships]: <process:05sall.js,run,process:shell commands>. \n5. [Relationships]: <process:malware,process,reg:registry>. \n6. [Relationships]: <process:malware,process,file:configuration>. ",
        "semantic_relationship": "[System-level Relationships]: <process:05sall.js,Fork,process:executable>. \n[System-level Relationships]: <process:05sall.js,Fork,process:update>. \n[System-level Relationships]: <process:05sall.js,Fork,process:terminate>. \n[System-level Relationships]: <process:05sall.js,Fork,process:shell commands>. \n[System-level Relationships]: <process:malware,Writekey,reg:registry>. \n[System-level Relationships]: <process:malware,Execute,file:configuration>. "
    },
    {
        "phase": "command and control",
        "content": "At this point in the analysis, there is one last loose end: what about the WinDivert packet capture library? We recovered a shellcode from one of the campaigns. This shellcode is decoded and run only in memory from a PowerShell command. It installs the following network filter (in a language recognized by WinDivert): \noutbound and ip and tcp.syn and tcp.ack $\\mathfrak{L}=~\\mathfrak{1}$ and loopback $\\scriptstyle=={\\widehat{\\mathbf{\\theta}}}$ \nThis means Nodersok is intercepting packets sent out to initiate a TCP connection. Once the filter is active, the shellcode is interested only in TCP packets that match the following specific format: \nThe packet must have standard Ethernet, ${|\\mathsf{P},}$ and 20 bytes TCP headers, plus an additional 20 bytes of TCP extra options. The options must appear exactly in the order shown in the image above: \n02 04 XX XX \u2013 Maximum segment size 01 \u2013 No operation ? 03 03 XX \u2013 Windows Scale 04 02 \u2013 SACK permitted 08 0A XX XX XX XX XX XX XX XX \u2013 Time stamps \nIf packets matching this criterion are detected, Nodersok modifies them by moving the \"SACK Permitted\" option to the end of the packet (whose size is extended by four bytes), and replacing the original option bytes with two \"No operation\" bytes. \nIt's possible that this modification benefits the attackers; for example, it may help evade some HIPS signatures. ",
        "relationship": "[Relationships]: None.",
        "semantic_relationship": "None"
    },
    {
        "phase_relationship": [
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:HTA file,reaches out to,socket:randomly named domain>. ",
                "semantic_relationship": "[System-level Relationships]: <process:HTA file,Connect,socket:randomly named domain>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:HTA file,downloads,file:JavaScript code>. ",
                "semantic_relationship": "[System-level Relationships]: <process:HTA file,Write,file:JavaScript code>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:HTA file,contacts,socket:C&C domain>. ",
                "semantic_relationship": "[System-level Relationships]: <process:HTA file,Connect,socket:C&C domain>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:file:1566444384.js,contacts,socket:C&C domain>. ",
                "semantic_relationship": "[System-level Relationships]: <process:file:1566444384.js,Connect,socket:C&C domain>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:file:1566444384.xsl,contacts,socket:C&C domain>. ",
                "semantic_relationship": "[System-level Relationships]: <process:file:1566444384.xsl,Connect,socket:C&C domain>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:file:1566444384.mp4,contacts,socket:C&C domain>. ",
                "semantic_relationship": "[System-level Relationships]: <process:file:1566444384.mp4,Connect,socket:C&C domain>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:file:1566444384.flv,contacts,socket:C&C domain>. ",
                "semantic_relationship": "[System-level Relationships]: <process:file:1566444384.flv,Connect,socket:C&C domain>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:PowerShell,launches,process:JavaScript snippet>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Fork,process:JavaScript snippet>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:HTA file,hides,file:malicious PowerShell script>. ",
                "semantic_relationship": "[System-level Relationships]: <process:HTA file,Write,file:malicious PowerShell script>. "
            },
            {
                "phase": "command and control",
                "relationship": "[Original Relationships]: <process:PowerShell,runs,file:deadbeef variable>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Execute,file:deadbeef variable>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,download,file:module.avi>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Write,file:module.avi>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,disable,process:Windows Defender Antivirus>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Exit,process:Windows Defender Antivirus>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,disable,process:Windows updates>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Exit,process:Windows updates>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,run,file:binary shellcode>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Execute,file:binary shellcode>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,download,file:trpl.png>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Write,file:trpl.png>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,download,file:strkp.png>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Write,file:strkp.png>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,download,file:node.exe>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Write,file:node.exe>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,drop,file:WinDivert.dll>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Delete,file:WinDivert.dll>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,drop,file:WinDivert32.sys>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Write,file:WinDivert32.sys>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,drop,file:WinDivert64.sys>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Delete,file:WinDivert64.sys>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:PowerShell,execute,file:shellcode>. ",
                "semantic_relationship": "[System-level Relationships]: <process:PowerShell,Execute,file:shellcode>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:node.exe,run,file:JavaScript payload>. ",
                "semantic_relationship": "[System-level Relationships]: <process:node.exe,Execute,file:JavaScript payload>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:05sall.js,run,process:executable>. ",
                "semantic_relationship": "[System-level Relationships]: <process:05sall.js,Fork,process:executable>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:05sall.js,run,process:update>. ",
                "semantic_relationship": "[System-level Relationships]: <process:05sall.js,Fork,process:update>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:05sall.js,run,process:terminate>. ",
                "semantic_relationship": "[System-level Relationships]: <process:05sall.js,Fork,process:terminate>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:05sall.js,run,process:shell commands>. ",
                "semantic_relationship": "[System-level Relationships]: <process:05sall.js,Fork,process:shell commands>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:malware,process,reg:registry>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Writekey,reg:registry>. "
            },
            {
                "phase": "execution",
                "relationship": "[Original Relationships]: <process:malware,process,file:configuration>. ",
                "semantic_relationship": "[System-level Relationships]: <process:malware,Execute,file:configuration>. "
            }
        ]
    }
]