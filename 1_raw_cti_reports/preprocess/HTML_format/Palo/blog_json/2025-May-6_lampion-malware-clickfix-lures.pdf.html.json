[
    {
        "level": 0,
        "content": "Lampion Is Back With ClickFix Lures"
    },
    {
        "level": 1,
        "content": "Executive Summary"
    },
    {
        "level": 3,
        "content": "Unit 42 researchers recently uncovered a highly focused malicious campaign targeting dozens of Portuguese organizations, particularly in the government, finance and transportation sectors. This campaign was orchestrated by the threat actors behind Lampion malware, an infostealer that focuses on sensitive banking information. This malware family has been active since at least 2019."
    },
    {
        "level": 3,
        "content": "During our investigation, we found that the group has added ClickFix lures to their arsenal. ClickFix is a social engineering technique that multiple malware families have adopted since late 2024, which lures victims to copy and execute malicious commands on their machine, under the guise of fixing computer problems."
    },
    {
        "level": 3,
        "content": "This campaign follows many of the same patterns as previous Lampion malware activity in terms of targets and infrastructure, as well as tactics, techniques and procedures (TTPs). These included multiple, highly obfuscated Visual Basic (VB) scripts as part of the attack chain, and similarities in the initial social engineering themes."
    },
    {
        "level": 3,
        "content": "While the final payload was commented out in the activity we observed, we could otherwise determine the full infection chain, including loaders. It is possible that a new wave of attacks could instead deliver the final payload."
    },
    {
        "level": 3,
        "content": "The techniques and activities presented in this article highlight the importance of implementing enhanced detection capabilities to identify complex and obfuscated threats."
    },
    {
        "level": 3,
        "content": "Palo Alto Networks customers are better protected from the threats described here through the following products and services:"
    },
    {
        "level": 3,
        "content": "Advanced WildFire \nAdvanced URL FilteringandAdvanced DNS Security \nCortex XDRandXSIAM"
    },
    {
        "level": 3,
        "content": "If you think you might have been compromised or have an urgent matter, contact theUnit 42 Incident Response team."
    },
    {
        "level": 1,
        "content": "Technical Analysis of the Lampion Campaign"
    },
    {
        "level": 3,
        "content": "Between late 2024 and early 2025, we noticed an increase in attacks against Portuguese companies. In the process of examining our telemetry, we noticed one campaign in particular that demonstrated unusual size and focus. Although the campaign used several measures to evade traditional detection mechanisms, we successfully identified and disrupted the infection chain."
    },
    {
        "level": 3,
        "content": "This campaign can be linked toLampionbanking malware, an infostealer that focuses on sensitive banking information. For example, the C2 server used in this campaign is the same server that was used in successful Lampion infections in the past. Furthermore, we found the same TTPs being used as in past Lampion campaigns: multiple, highly obfuscated VB scripts, indirect execution of consecutive stages, and similar initial infection lure subjects."
    },
    {
        "level": 2,
        "content": "Infection Chain Analysis: A Long and Winding Road"
    },
    {
        "level": 3,
        "content": "The campaign’s infection chain began with a phishing email that contains a malicious ZIP file attachment. An HTML file within this ZIP file redirects the victim toautoridade-tributaria[.]com, a website mimicking a legitimate Portuguese tax authority."
    },
    {
        "level": 3,
        "content": "Upon going to the website, the victim is then presented with a fake document or software installation page that prompts them to copy a malicious PowerShell command and execute it in the Run dialog. This command includes a comment in Portuguese: “#Habilitar Visualização de ficheiro” (this translates to “Enable File Preview” in English). This is shown at the end of the code snippet below."
    },
    {
        "level": 3,
        "content": "This command is the heart of the ClickFix fraud, which is a technique that is being used by various crimeware strains such asLumma StealerandNetSupport RAT— and now also Lampion. When an attacker uses ClickFix in a social engineering attack, the victim is prompted to copy malicious commands to their Run dialog or terminals to “fix” a certain problem."
    },
    {
        "level": 3,
        "content": "This technique manipulates the victim into running a malicious command that infects their machine."
    },
    {
        "level": 3,
        "content": "The victim’s execution of the malicious PowerShell command downloads and executes an obfuscated Visual Basic Script (VBS) file, which is part of this campaign. Figure 1 depicts the infection chain below."
    },
    {
        "level": 3,
        "content": "Another interesting aspect of Lampion’s infection chain is that it is divided into several non-consecutive stages, executed as separate processes. This dispersed execution complicates detection, as the attack flow does not form a readily identifiable process tree. Instead, it comprises a complex chain of individual events, some of which could appear benign in isolation."
    },
    {
        "level": 3,
        "content": "In the next section, we take a deep dive into the VBS infection chain, which combines multiple obfuscation andbloating techniquesthat attackers implemented in these scripts."
    },
    {
        "level": 2,
        "content": "Analysis of Stages 1 and 2: Initial VBS Downloaders"
    },
    {
        "level": 3,
        "content": "The first and second stages of this campaign have several different versions, mainly varying in size and filenames. Overall, both use multiple obfuscation methods such as junk variables and indirect ASCII conversions to bloat the original code to a significant size. This type of obfuscation hinders the work of both defenders and analysts, by obscuring the script’s main functionality."
    },
    {
        "level": 3,
        "content": "Once the first stage is executed, it writes a similarly obfuscated second-stage downloader in the%TEMP%folder. To further thwart detection, the first stage does not directly execute the second but rather creates a hidden scheduled task to be triggered at a random time."
    },
    {
        "level": 3,
        "content": "The sole function of the second stage is to download yet another VBS stager from a cloud-hosted server. This stager is disguised as a PHP file, a technique used repeatedly throughout this campaign. Figure 2 shows a deobfuscated code snippet from the first stage responsible for writing the second stage."
    },
    {
        "level": 2,
        "content": "Analysis of Stage 3: The Final VBS Payload"
    },
    {
        "level": 3,
        "content": "The third VBS stands out due to its large size (between 30 MB and 50 MB). Although it is filled with junk variables and obfuscated functions, this stage is also more robust in its functions."
    },
    {
        "level": 3,
        "content": "The third stage VBS is in charge of reconnaissance and detection evasion maneuvers, such as:"
    },
    {
        "level": 3,
        "content": "Checking for existing security products using Windows Management Instrumentation (WMI) \nDiscerning whether the victim’s machine is a sandbox or virtual machine (VM) \nGathering initial data on the targeted endpoint, including a unique MD5 value of a victim ID, Base64-encoded under the GET request parameterdados=(“data” in Portuguese) \nSending the encoded ID to the cloud-hosted command-and-control (C2) server"
    },
    {
        "level": 3,
        "content": "Figure 3 depicts the process tree generated during stage 3 execution."
    },
    {
        "level": 3,
        "content": "Similar to the previous stages, the third stage does not directly execute the fourth stage but instead creates a complex execution method:"
    },
    {
        "level": 3,
        "content": "First, it writes the content of the command shown in Figure 3 into a.cmdfile in the Windows startup folder and names it after the victim’s hostname \nAfterwards, the script creates a hidden scheduled task that forces the system to shut down \nThe shutdown triggers the execution of the.cmdfile during the subsequent startup, ultimately launching the fourth-stage DLL loader withrundll32.exe"
    },
    {
        "level": 3,
        "content": "We believe the threat actor reuses this stage across multiple campaigns with varying infection vectors. By looking at the comments present in the script, we can see a decoded version of acurlcommand that was supposed to download the final Lampion payload from the attacker’s C2. Since the attacker deactivated the command for downloading the payload by placing it within a comment block, the final Lampion payload was not downloaded in this campaign."
    },
    {
        "level": 3,
        "content": "Furthermore, the attacker left other comments that revealed the script’s functionality in Portuguese (such as “obtain information on antivirus software,” shown in Figure 5)."
    },
    {
        "level": 3,
        "content": "Despite their many efforts to obfuscate code, in certain cases the attacker kept an unencoded version of some of the commands that the code executed. These are translated into natural language and placed in comments, as shown in Figure 6."
    },
    {
        "level": 3,
        "content": "Analysis of Stage 4: The Loader DLLAfter exfiltrating initial reconnaissance data, the third stage VBScript tries to download the fourth stage — a DLL loader — from another cloud-hosted address that redirects tohxxps://inde-faturas[.]com/54879878. The fourth stage DLL’s name is generated from the infection timestamp, inYYYYMMDDHHmmSSformat (e.g.,20241201120101.dll)."
    },
    {
        "level": 3,
        "content": "This loader variant is also extremely large, at over 700 MB. This makes it impossible for people to upload to crowd-sourced threat intelligence platforms, thus increasing the difficulty for defenders."
    },
    {
        "level": 3,
        "content": "As outlined above, the DLL is triggered byrundll32.exe, which calls a different export function for each unique victim. All functions are usually words in Portuguese, unlike past campaigns in which the fourth stage was triggered by a randomized function name."
    },
    {
        "level": 3,
        "content": "Unlike previous campaigns that downloaded the fourth stage along with a zipped Lampion payload, this campaign only downloads the aforementioned DLL. This could indicate either a mistake on the attacker’s part or a testing phase for the next wave of attacks. The commented-out commands relating to the.zippayload download suggest incomplete or incorrect content."
    },
    {
        "level": 3,
        "content": "Conclusion"
    },
    {
        "level": 3,
        "content": "We recently detected a campaign that targets Portuguese-speaking individuals and organizations in various sectors, including government, finance and transportation. This campaign aligns with TTPs and indicators that Lampion used in the past. It also shows the group’s adaptation of a new initial attack vector: ClickFix lures."
    },
    {
        "level": 3,
        "content": "The increasing prevalence of ClickFix, coupled with low awareness of its risks, poses a significant threat. We advise security practitioners to proactively address this evolving threat by:"
    },
    {
        "level": 3,
        "content": "Increasing awareness by educating personnel to be wary of ClickFix lures \nSetting up defense and monitoring measures for PowerShell scripting and clipboard activity"
    },
    {
        "level": 3,
        "content": "Palo Alto Networks Protection and Mitigation"
    },
    {
        "level": 3,
        "content": "Palo Alto Networks customers are better protected from the Lampion attack vector throughCortex XDRandXSIAM."
    },
    {
        "level": 3,
        "content": "Cortex XDR VBS Local Analysis Module andAdvanced WildFireclassify the Lampion VBS loader samples discussed in this article as malicious."
    },
    {
        "level": 3,
        "content": "Advanced URL FilteringandAdvanced DNS Securityidentify known URLs and domains associated with ClickFix campaigns as malicious."
    },
    {
        "level": 3,
        "content": "If you think you may have been compromised or have an urgent matter, get in touch with theUnit 42 Incident Response teamor call:"
    },
    {
        "level": 3,
        "content": "North America: Toll Free: +1 (866) 486-4842 (866.4.UNIT42) \nUK: +44.20.3743.3660 \nEurope and Middle East: +31.20.299.3130 \nAsia: +65.6983.8730 \nJapan: +81.50.1790.0200 \nAustralia: +61.2.4062.7950 \nIndia: 00080005045107"
    },
    {
        "level": 3,
        "content": "Palo Alto Networks has shared these findings with our fellow Cyber Threat Alliance (CTA) members. CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors. Learn more about theCyber Threat Alliance."
    },
    {
        "level": 1,
        "content": "Appendix A"
    },
    {
        "level": 2,
        "content": "Detection With Cortex XDR VBS Local Analysis Module"
    },
    {
        "level": 3,
        "content": "The new Cortex XDR VBS Local Analysis Module provides enhanced detection capabilities to identify complex and obfuscated VBS threats. In the campaign described above, several rules were triggered by malicious activity originating from impacted endpoints. Figure 7 below depicts alerts that were triggered due to the execution of malicious VBScripts as part of the attack."
    },
    {
        "level": 1,
        "content": "Indicators of Compromise"
    },
    {
        "level": 3,
        "content": "Phishing Email"
    },
    {
        "level": 3,
        "content": "ee4c8e4cce55bd40afa1fb0bc0eee3d7c23d0ebe2db48c2092e854f6ca1472ce"
    },
    {
        "level": 3,
        "content": "Stage 1 VBS"
    },
    {
        "level": 3,
        "content": "4aeb84dd71588a35084109ff5525c7bff2f30e0ed58ce139621b17f2374bdb35"
    },
    {
        "level": 3,
        "content": "Stage 2 VBS"
    },
    {
        "level": 3,
        "content": "bba48cf24bb9e6bdcbc79c2241f101e3dd4127ab450e3dbbe1b79fa738f06483 \n29b63fcf8e5f08fd12166507b3a85746e3ec685ae0620a124e64125ecd9ccf9b"
    },
    {
        "level": 3,
        "content": "Stage 3 VBS"
    },
    {
        "level": 3,
        "content": "58fe2a7d4435c9c24c98d33aff1110add4bf95add31558f51289a028ddafcc6e \n334dfbaefbf7e6301d2385f95d861eb6dae9018c48fb298a2cbf5f364fbcdb2d \n1681c3b88ed315543ac1bf07d258d560cf2f85bfd26c10471d71700eaeb57fb3"
    },
    {
        "level": 3,
        "content": "Lampion C2 Stage 4 Loader"
    },
    {
        "level": 3,
        "content": "5.8.9[.]77 \n83.242.96[.]159"
    },
    {
        "level": 3,
        "content": "Domains"
    },
    {
        "level": 3,
        "content": "Inde-faturas[.]com \nautoridade-tributaria[.]com"
    },
    {
        "level": 3,
        "content": "C2 URLs"
    },
    {
        "level": 3,
        "content": "http://18.116.63[.]61/ifeellike.php \nhttp://18.116.63[.]61/trogloditas.php \nhttp://3.135.249[.]199/prayfor.php \nhttp://18.217.122[.]187/proposito.php \nhttp://18.226.150[.]56/persistir.php \nhttp://3.142.40[.]36/grow.php \nhttp://18.216.78[.]94/aceitalo.php \nhttp://3.23.103[.]13/stick.php"
    },
    {
        "level": 3,
        "content": "C2 IPv4 Addresses (Cloud-Hosted)"
    },
    {
        "level": 3,
        "content": "18.221.69[.]167 \n18.222.97[.]143 \n18.116.15[.]129 \n18.220.96[.]58 \n3.135.200[.]135 \n18.191.192[.]110 \n18.224.38[.]123 \n18.118.163[.]100 \n3.147.127[.]14 \n3.138.32[.]196 \n18.117.11[.]70 \n18.117.173[.]119 \n18.116.28[.]153 \n3.16.76[.]203 \n3.15.7[.]241 \n3.15.155[.]141 \n18.117.71[.]203 \n3.133.160[.]140 \n3.133.113[.]215 \n3.143.24[.]42 \n18.217.180[.]185 \n3.23.105[.]171 \n3.142.200[.]117 \n3.128.34[.]187 \n18.191.240[.]233 \n3.147.86[.]100"
    },
    {
        "level": 1,
        "content": "Additional Resources"
    },
    {
        "level": 3,
        "content": "Lumma Stealer ClickFix Distribution– eSentire \nSecurity Brief: ClickFix Social Engineering Technique Floods Threat Landscape– ProofPoint \nClickFix: The Social Engineering Technique Hackers Use to Manipulate Victims– Group-IB \nNew Lampion Variant In The Wild [PDF]– SOC8 Technical Report, Layer8 \nTargeting Portugal: A new trojan ‘Lampion’ has spread using template emails from the Portuguese Government Finance & Tax– Segurança Informática \nData Obfuscation: Junk Data– MITRE ATT&CK"
    }
]